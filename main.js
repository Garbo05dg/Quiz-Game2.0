const translations = {
    en: {
      welcome: "Quiz Game",
      register: "Register",
      login: "Login",
      guest: "Continue as Guest",
      username: "Username",
      password: "Password",
      country: "Country",
      continue: "Continue",
      create_lobby: "Create Lobby",
      join_lobby: "Join a Lobby",
      start_game: "Start Game",
      players: "Players in Lobby:",
      ready: "Ready for a new game",
      waiting: "Waiting for other players...",
      game_over: "Game Over!",
      score: "Score",
      victories: "Victories",
      correct: "Correct Answers",
      wrong: "Wrong Answers",
      games_played: "Games Played",
      level: "Level",
      logout: "Logout",
      close: "Close",
      back: "Back",
      enter_lobby_id: "Enter Lobby ID",
      join: "Join",
      num_questions: "Number of questions",
      start: "Start Game",
      profile: "Profile",
      xp: "XP",
      xp_next: "XP for next level",
      games_played: "Games Played",
      victories: "Victories",
      correct: "Correct Answers",
      wrong: "Wrong Answers",
      time_left: "Time left",
      time_up: "Time's up!",
      profile_language: "Language",
      username_label: "Username",
          correct_answer: "Correct answer!",
      wrong_answer: "Wrong answer!",
      enter_name: "Please enter a name!",
      fill_all_fields: "Fill in all fields to register!",
      login_error: "Login error",
      register_error: "Registration error",
      connection_error: "Connection error",
      scoreboard: "Scoreboard",
      player: "Player"
    },
    es: {
      welcome: "Juego de preguntas",
      register: "Registrarse",
      login: "Iniciar sesión",
      guest: "Continuar como invitado",
      username: "Nombre de usuario",
      password: "Contraseña",
      country: "País",
      continue: "Continuar",
      create_lobby: "Crear sala",
      join_lobby: "Unirse a una sala",
      start_game: "Comenzar juego",
      players: "Jugadores en la sala:",
      ready: "Listo para un nuevo juego",
      waiting: "Esperando a otros jugadores...",
      game_over: "¡Juego terminado!",
      score: "Puntuación",
      victories: "Victorias",
      correct: "Respuestas correctas",
      wrong: "Respuestas incorrectas",
      games_played: "Partidas jugadas",
      level: "Nivel",
      xp: "XP",
      xp_next: "XP para el siguiente nivel",
      logout: "Cerrar sesión",
      close: "Cerrar",
      back: "Atrás",
      enter_lobby_id: "Introduce el ID de la sala",
      join: "Unirse",
      num_questions: "Número de preguntas",
      start: "Comenzar juego",
      profile: "Perfil",
      games_played: "Partidas jugadas",
      victories: "Victorias",
      correct: "Respuestas correctas",
      wrong: "Respuestas incorrectas",
      time_left: "Tiempo restante",
      time_up: "¡Tiempo terminado!",
      profile_language: "Idioma",
      username_label: "Nombre de usuario",
          correct_answer: "¡Respuesta correcta!",
      wrong_answer: "¡Respuesta incorrecta!",
      enter_name: "¡Introduce un nombre!",
      fill_all_fields: "¡Rellena todos los campos para registrarte!",
      login_error: "Error de inicio de sesión",
      register_error: "Error de registro",
      connection_error: "Error de conexión",
      scoreboard: "Clasificación",
      player: "Jugador"
    },
    fr: {
      welcome: "Quiz Game",
      register: "S'inscrire",
      login: "Connexion",
      guest: "Continuer en tant qu'invité",
      username: "Nom d'utilisateur",
      password: "Mot de passe",
      country: "Pays",
      continue: "Continuer",
      create_lobby: "Créer un salon",
      join_lobby: "Rejoindre un salon",
      start_game: "Démarrer le jeu",
      players: "Joueurs dans le salon :",
      ready: "Prêt pour une nouvelle partie",
      waiting: "En attente d'autres joueurs...",
      game_over: "Partie terminée !",
      score: "Score",
      victories: "Victoires",
      correct: "Bonnes réponses",
      wrong: "Mauvaises réponses",
      games_played: "Parties jouées",
      level: "Niveau",
      xp: "XP",
      xp_next: "XP pour le niveau suivant",
      logout: "Déconnexion",
      close: "Fermer",
      back: "Retour",
      enter_lobby_id: "Entrer l'ID du salon",
      join: "Rejoindre",
      num_questions: "Nombre de questions",
      start: "Démarrer le jeu",
      profile: "Profil",
      
      games_played: "Parties jouées",
      victories: "Victoires",
      correct: "Bonnes réponses",
      wrong: "Mauvaises réponses",
      time_left: "Temps restant",
      time_up: "Temps écoulé !",
      profile_language: "Langue",
      username_label: "Nom d'utilisateur",
          correct_answer: "Bonne réponse !",
      wrong_answer: "Mauvaise réponse !",
      enter_name: "Veuillez entrer un nom !",
      fill_all_fields: "Veuillez remplir tous les champs pour vous inscrire !",
      login_error: "Erreur de connexion",
      register_error: "Erreur d'inscription",
      connection_error: "Erreur de connexion",
      scoreboard: "Classement",
      player: "Joueur"
    },
    de: {
      welcome: "Quiz-Spiel",
      register: "Registrieren",
      login: "Anmelden",
      guest: "Als Gast fortfahren",
      username: "Benutzername",
      password: "Passwort",
      country: "Land",
      continue: "Weiter",
      create_lobby: "Lobby erstellen",
      join_lobby: "Lobby beitreten",
      start_game: "Spiel starten",
      players: "Spieler in der Lobby:",
      ready: "Bereit für ein neues Spiel",
      waiting: "Warten auf andere Spieler...",
      game_over: "Spiel beendet!",
      score: "Punktzahl",
      victories: "Siege",
      correct: "Richtige Antworten",
      wrong: "Falsche Antworten",
      games_played: "Gespielte Spiele",
      level: "Level",
      xp: "EP",
      xp_next: "EP für das nächste Level",
      logout: "Abmelden",
      close: "Schließen",
      back: "Zurück",
      enter_lobby_id: "Lobby-ID eingeben",
      join: "Beitreten",
      num_questions: "Anzahl der Fragen",
      start: "Spiel starten",
      profile: "Profil",
      
      games_played: "Gespielte Spiele",
      victories: "Siege",
      correct: "Richtige Antworten",
      wrong: "Falsche Antworten",
      time_left: "Verbleibende Zeit",
      time_up: "Zeit abgelaufen!",
      profile_language: "Sprache",
      username_label: "Benutzername",
          correct_answer: "Richtige Antwort!",
      wrong_answer: "Falsche Antwort!",
      enter_name: "Bitte einen Namen eingeben!",
      fill_all_fields: "Bitte alle Felder ausfüllen!",
      login_error: "Anmeldefehler",
      register_error: "Registrierungsfehler",
      connection_error: "Verbindungsfehler",
      scoreboard: "Bestenliste",
      player: "Spieler"
    },
    it: {
      welcome: "Quiz Game",
      register: "Registrati",
      login: "Login",
      guest: "Continua come Ospite",
      username: "Username",
      password: "Password",
      country: "Paese",
      continue: "Continua",
      create_lobby: "Crea una Lobby",
      join_lobby: "Unisciti a una Lobby",
      start_game: "Inizia Gioco",
      players: "Giocatori nella Lobby:",
      ready: "Pronto per una nuova partita",
      waiting: "In attesa degli altri giocatori...",
      game_over: "Gioco Terminato!",
      score: "Punteggio",
      victories: "Vittorie",
      correct: "Risposte corrette",
      wrong: "Risposte sbagliate",
      games_played: "Partite giocate",
      level: "Livello",
      xp: "XP",
      xp_next: "XP per il prossimo livello",
      logout: "Logout",
      close: "Chiudi",
      back: "Indietro",
      enter_lobby_id: "Inserisci l'ID della lobby",
      join: "Unisciti",
      num_questions: "Numero di domande",
      start: "Inizia Gioco",
      profile: "Profilo",
    games_played: "Partite giocate",
    victories: "Vittorie",
    correct: "Risposte corrette",
    wrong: "Risposte sbagliate",
    time_left: "Tempo rimanente",
    time_up: "Tempo scaduto!",
    profile_language: "Lingua",
    username_label: "Nome utente",
    correct_answer: "Risposta corretta!",
      wrong_answer: "Risposta sbagliata!",
      enter_name: "Inserisci un nome!",
      fill_all_fields: "Compila tutti i campi per registrarti!",
      login_error: "Errore di login",
      register_error: "Errore di registrazione",
      connection_error: "Errore di connessione",
      scoreboard: "Classifica",
      player: "Giocatore"
    },
    pt: {
      welcome: "Quiz Game",
      register: "Registrar",
      login: "Entrar",
      guest: "Continuar como convidado",
      username: "Nome de usuário",
      password: "Senha",
      country: "País",
      continue: "Continuar",
      create_lobby: "Criar sala",
      join_lobby: "Entrar em sala",
      start_game: "Iniciar jogo",
      players: "Jogadores na sala:",
      ready: "Pronto para um novo jogo",
      waiting: "Aguardando outros jogadores...",
      game_over: "Jogo terminado!",
      score: "Pontuação",
      victories: "Vitórias",
      correct: "Respostas corretas",
      wrong: "Respostas erradas",
      games_played: "Jogos jogados",
      level: "Nível",
      xp: "XP",
      xp_next: "XP para o próximo nível",
      logout: "Sair",
      close: "Fechar",
      back: "Voltar",
      enter_lobby_id: "Digite o ID da sala",
      join: "Entrar",
      num_questions: "Número de perguntas",
      start: "Iniciar jogo",
      profile: "Perfil",
      
      games_played: "Jogos jogados",
      victories: "Vitórias",
      correct: "Respostas corretas",
      wrong: "Respostas erradas",
      time_left: "Tempo restante",
      time_up: "Tempo esgotado!",
      profile_language: "Idioma",
      username_label: "Nome de usuário",
          correct_answer: "Resposta correta!",
      wrong_answer: "Resposta errada!",
      enter_name: "Insira um nome!",
      fill_all_fields: "Preencha todos os campos para se registrar!",
      login_error: "Erro de login",
      register_error: "Erro de registro",
      connection_error: "Erro de conexão",
      scoreboard: "Classificação",
      player: "Jogador"
    },
    ru: {
      welcome: "Викторина",
      register: "Регистрация",
      login: "Войти",
      guest: "Продолжить как гость",
      username: "Имя пользователя",
      password: "Пароль",
      country: "Страна",
      continue: "Продолжить",
      create_lobby: "Создать лобби",
      join_lobby: "Присоединиться к лобби",
      start_game: "Начать игру",
      players: "Игроки в лобби:",
      ready: "Готов к новой игре",
      waiting: "Ожидание других игроков...",
      game_over: "Игра окончена!",
      score: "Счет",
      victories: "Победы",
      correct: "Правильные ответы",
      wrong: "Неправильные ответы",
      games_played: "Сыграно игр",
      level: "Уровень",
      xp: "ОП",
      xp_next: "ОП до следующего уровня",
      logout: "Выйти",
      close: "Закрыть",
      back: "Назад",
      enter_lobby_id: "Введите ID лобби",
      join: "Присоединиться",
      num_questions: "Количество вопросов",
      start: "Начать игру",
      profile: "Профиль",
      games_played: "Сыграно игр",
      victories: "Победы",
      correct: "Правильные ответы",
      wrong: "Неправильные ответы",
      time_left: "Оставшееся время",
      time_up: "Время вышло!",
      profile_language: "Язык",
      username_label: "Имя пользователя",
          correct_answer: "Правильный ответ!",
      wrong_answer: "Неправильный ответ!",
      enter_name: "Пожалуйста, введите имя!",
      fill_all_fields: "Заполните все поля для регистрации!",
      login_error: "Ошибка входа",
      register_error: "Ошибка регистрации",
      connection_error: "Ошибка соединения",
      scoreboard: "Таблица лидеров",
      player: "Игрок"
    },
    zh: {
      welcome: "问答游戏",
      register: "注册",
      login: "登录",
      guest: "以访客身份继续",
      username: "用户名",
      password: "密码",
      country: "国家",
      continue: "继续",
      create_lobby: "创建房间",
      join_lobby: "加入房间",
      start_game: "开始游戏",
      players: "房间内玩家：",
      ready: "准备好新游戏",
      waiting: "等待其他玩家...",
      game_over: "游戏结束！",
      score: "得分",
      victories: "胜利",
      correct: "正确答案",
      wrong: "错误答案",
      games_played: "已玩游戏",
      level: "等级",
      xp: "经验",
      xp_next: "下一级所需经验",
      logout: "登出",
      close: "关闭",
      back: "返回",
      enter_lobby_id: "输入房间ID",
      join: "加入",
      num_questions: "问题数量",
      start: "开始游戏",
      profile: "个人资料",
    
      games_played: "已玩游戏",
      victories: "胜利",
      correct: "正确答案",
      wrong: "错误答案",
      time_left: "剩余时间",
      time_up: "时间到！",
      profile_language: "语言",
      username_label: "用户名",
          correct_answer: "回答正确！",
      wrong_answer: "回答错误！",
      enter_name: "请输入姓名！",
      fill_all_fields: "请填写所有注册字段！",
      login_error: "登录错误",
      register_error: "注册错误",
      connection_error: "连接错误",
      scoreboard: "排行榜",
      player: "玩家"
    },
    ar: {
      welcome: "لعبة الأسئلة",
      register: "تسجيل",
      login: "تسجيل الدخول",
      guest: "المتابعة كضيف",
      username: "اسم المستخدم",
      password: "كلمة المرور",
      country: "الدولة",
      continue: "استمرار",
      create_lobby: "إنشاء غرفة",
      join_lobby: "الانضمام إلى غرفة",
      start_game: "بدء اللعبة",
      players: "اللاعبون في الغرفة:",
      ready: "جاهز للعبة جديدة",
      waiting: "بانتظار لاعبين آخرين...",
      game_over: "انتهت اللعبة!",
      score: "النقاط",
      victories: "الانتصارات",
      correct: "إجابات صحيحة",
      wrong: "إجابات خاطئة",
      games_played: "الألعاب التي تم لعبها",
      level: "المستوى",
      logout: "تسجيل الخروج",
      close: "إغلاق",
      back: "عودة",
      enter_lobby_id: "أدخل معرف الغرفة",
      join: "انضم",
      num_questions: "عدد الأسئلة",
      start: "بدء اللعبة",
      profile: "الملف الشخصي",
      xp: "نقاط الخبرة",
      xp_next: "نقاط الخبرة للمستوى التالي",
      games_played: "الألعاب التي تم لعبها",
      victories: "الانتصارات",
      correct: "إجابات صحيحة",
      wrong: "إجابات خاطئة",
      time_left: "الوقت المتبقي",
      time_up: "انتهى الوقت!",
      profile_language: "اللغة",
      username_label: "اسم المستخدم",
          correct_answer: "إجابة صحيحة!",
      wrong_answer: "إجابة خاطئة!",
      enter_name: "يرجى إدخال اسم!",
      fill_all_fields: "يرجى ملء جميع الحقول للتسجيل!",
      login_error: "خطأ في تسجيل الدخول",
      register_error: "خطأ في التسجيل",
      connection_error: "خطأ في الاتصال",
      scoreboard: "لوحة الصدارة",
      player: "لاعب"
    },
    ja: {
      welcome: "クイズゲーム",
      register: "登録",
      login: "ログイン",
      guest: "ゲストとして続行",
      username: "ユーザー名",
      password: "パスワード",
      country: "国",
      continue: "続行",
      create_lobby: "ロビーを作成",
      join_lobby: "ロビーに参加",
      start_game: "ゲーム開始",
      players: "ロビーのプレイヤー：",
      ready: "新しいゲームの準備完了",
      waiting: "他のプレイヤーを待っています...",
      game_over: "ゲーム終了！",
      score: "スコア",
      victories: "勝利数",
      correct: "正解数",
      wrong: "不正解数",
      games_played: "プレイしたゲーム数",
      level: "レベル",
      xp: "経験値",
      xp_next: "次のレベルまでの経験値",
      logout: "ログアウト",
      close: "閉じる",
      back: "戻る",
      enter_lobby_id: "ロビーIDを入力",
      join: "参加",
      num_questions: "質問数",
      start: "ゲーム開始",
      profile: "プロフィール",
      games_played: "プレイしたゲーム数",
      victories: "勝利数",
      correct: "正解数",
      wrong: "不正解数",
      time_left: "残り時間",
      time_up: "時間切れ！",
      profile_language: "言語",
      username_label: "ユーザー名",
          correct_answer: "正解！",
      wrong_answer: "不正解！",
      enter_name: "名前を入力してください！",
      fill_all_fields: "すべての項目を入力してください！",
      login_error: "ログインエラー",
      register_error: "登録エラー",
      connection_error: "接続エラー",
      scoreboard: "スコアボード",
      player: "プレイヤー"
    },
    hi: {
      welcome: "क्विज़ गेम",
      register: "रजिस्टर करें",
      login: "लॉगिन",
      guest: "मेहमान के रूप में जारी रखें",
      username: "यूज़रनेम",
      password: "पासवर्ड",
      country: "देश",
      continue: "जारी रखें",
      create_lobby: "लॉबी बनाएँ",
      join_lobby: "लॉबी में शामिल हों",
      start_game: "खेल शुरू करें",
      players: "लॉबी में खिलाड़ी:",
      ready: "नए खेल के लिए तैयार",
      waiting: "अन्य खिलाड़ियों की प्रतीक्षा कर रहे हैं...",
      game_over: "खेल समाप्त!",
      score: "स्कोर",
      victories: "विजय",
      correct: "सही उत्तर",
      wrong: "गलत उत्तर",
      games_played: "खेले गए खेल",
      level: "स्तर",
      xp: "XP",
      xp_next: "अगले स्तर के लिए XP",
      logout: "लॉगआउट",
      close: "बंद करें",
      back: "वापस",
      enter_lobby_id: "लॉबी आईडी दर्ज करें",
      join: "शामिल हों",
      num_questions: "प्रश्नों की संख्या",
      start: "खेल शुरू करें",
      profile: "प्रोफ़ाइल",
      games_played: "खेले गए खेल",
      victories: "विजय",
      correct: "सही उत्तर",
      wrong: "गलत उत्तर",
      time_left: "शेष समय",
      time_up: "समय समाप्त!",
      profile_language: "भाषा",
      username_label: "यूज़रनेम",
          correct_answer: "सही उत्तर!",
      wrong_answer: "गलत उत्तर!",
      enter_name: "कृपया नाम दर्ज करें!",
      fill_all_fields: "पंजीकरण के लिए सभी फ़ील्ड भरें!",
      login_error: "लॉगिन त्रुटि",
      register_error: "पंजीकरण त्रुटि",
      connection_error: "कनेक्शन त्रुटि",
      scoreboard: "स्कोरबोर्ड",
      player: "खिलाड़ी"
    }
  };

  // Funzione per guest mode: deve essere subito dopo translations!
  function isGuestMode() {
    return localStorage.getItem('isGuest') === 'true';
  }

  // Background color palettes for each theme
  const BACKGROUND_PALETTES = {
    'backgrounds/bg1.jpg': {
      '--bg-primary': '#1a1a2e',
      '--bg-secondary': '#16213e',
      '--container-bg': 'rgba(22,33,62,0.96)',
      '--text-primary': '#fff',
      '--text-secondary': '#e2e2e2',
      '--accent-color': '#0f3460',
      '--button-bg': '#0f3460',
      '--button-text': '#fff',
      '--modal-bg': 'rgba(22,33,62,0.98)',
      '--input-bg': '#1a1a2e',
      '--border-color': '#5ad1ff',
      '--question-bg': '#16213e',
      '--answer-bg': '#1a1a2e',
      '--answer-hover-bg': '#0f3460',
      '--correct-bg': '#43e97b', // verde brillante su sfondo blu/viola
      '--incorrect-bg': '#c0392b',
      '--topbar-bg': '#16213e',
      '--text-shadow': '#5ad1ff',
      '--title-color': '#5ad1ff',
      '--title-shadow': '#fff',
      '--selected-bg': '#5ad1ff' // azzurro brillante su blu/viola
    },
    'backgrounds/bg2.jpg': {
      '--bg-primary': '#e3f9e5',
      '--bg-secondary': '#b7e4c7',
      '--container-bg': '#e3f9e5',
      '--text-primary': '#234d20',
      '--text-secondary': '#4f772d',
      '--accent-color': '#f9dc5c',
      '--button-bg': '#f9dc5c',
      '--button-text': '#234d20',
      '--modal-bg': '#b7e4c7',
      '--input-bg': '#d8f3dc',
      '--border-color': '#4f772d',
      '--question-bg': '#d8f3dc',
      '--answer-bg': '#f6fff8',
      '--answer-hover-bg': '#f9dc5c',
      '--correct-bg': '#43e97b', // già ben visibile, verde chiaro
      '--incorrect-bg': '#f28482',
      '--topbar-bg': '#b7e4c7',
      '--text-shadow': '#4f772d',
      '--title-color': '#234d20',
      '--title-shadow': '#f9dc5c',
      '--selected-bg': '#f9dc5c' // giallo acceso su verde/bianco
    },
    'backgrounds/bg3.jpg': {
      '--bg-primary': '#ffe9b0', // sabbia chiara
      '--bg-secondary': '#ffe066', // giallo sabbia
      '--container-bg': 'rgba(255,233,176,0.96)',
      '--text-primary': '#2d3a4a', // blu scuro
      '--text-secondary': '#f77f00', // arancio accento
      '--accent-color': '#f77f00', // arancio accento
      '--button-bg': '#f77f00',
      '--button-text': '#fff',
      '--modal-bg': 'rgba(255,224,102,0.98)',
      '--input-bg': '#fffbe6',
      '--border-color': '#f77f00',
      '--question-bg': '#fffbe6',
      '--answer-bg': '#ffe9b0',
      '--answer-hover-bg': '#f77f00',
      '--correct-bg': '#27ae60', // verde acceso su sabbia/giallo
      '--incorrect-bg': '#e63946',
      '--topbar-bg': '#ffe066',
      '--text-shadow': '#f77f00',
      '--title-color': '#f77f00',
      '--title-shadow': '#fffbe6',
      '--selected-bg': '#f77f00' // arancio acceso su sabbia/giallo
    },
    'backgrounds/bg4.jpg': {
      '--bg-primary': '#232c4a',
      '--bg-secondary': '#2c3e50',
      '--container-bg': 'rgba(44,62,80,0.96)',
      '--text-primary': '#ecf0f1',
      '--text-secondary': '#bdc3c7',
      '--accent-color': '#f7c873',
      '--button-bg': '#34495e',
      '--button-text': '#fff',
      '--modal-bg': 'rgba(44,62,80,0.98)',
      '--input-bg': '#232c4a',
      '--border-color': '#f7c873',
      '--question-bg': '#2c3e50',
      '--answer-bg': '#232c4a',
      '--answer-hover-bg': '#f7c873',
      '--correct-bg': '#43e97b', // verde brillante su blu notte
      '--incorrect-bg': '#c0392b',
      '--topbar-bg': '#2c3e50',
      '--text-shadow': '#f7c873',
      '--title-color': '#f7c873',
      '--title-shadow': '#fff',
      '--selected-bg': '#f7c873' // giallo caldo su blu notte
    },
    'backgrounds/bg5.jpg': {
      '--bg-primary': '#ffb347',
      '--bg-secondary': '#ffcc80',
      '--container-bg': 'rgba(255,179,71,0.96)',
      '--text-primary': '#2d3a4a',
      '--text-secondary': '#f77f00',
      '--accent-color': '#f77f00',
      '--button-bg': '#f77f00',
      '--button-text': '#fff',
      '--modal-bg': 'rgba(255,204,128,0.98)',
      '--input-bg': '#fffbe6',
      '--border-color': '#f77f00',
      '--question-bg': '#fffbe6',
      '--answer-bg': '#ffb347',
      '--answer-hover-bg': '#f77f00',
      '--correct-bg': '#27ae60', // verde acceso su tramonto/giallo
      '--incorrect-bg': '#e63946',
      '--topbar-bg': '#ffcc80',
      '--text-shadow': '#f77f00',
      '--title-color': '#f77f00',
      '--title-shadow': '#fffbe6',
      '--selected-bg': '#f77f00' // arancio acceso su tramonto/giallo
    },
    'backgrounds/bg6.jpg': {
      '--bg-primary': '#e0f7fa', // azzurro cielo
      '--bg-secondary': '#b2dfdb', // verde acqua
      '--container-bg': 'rgba(224,247,250,0.96)',
      '--text-primary': '#145374', // blu montagna
      '--text-secondary': '#55828b', // blu/verde
      '--accent-color': '#55828b',
      '--button-bg': '#55828b',
      '--button-text': '#fff',
      '--modal-bg': 'rgba(178,223,219,0.98)',
      '--input-bg': '#e0f7fa',
      '--border-color': '#145374',
      '--question-bg': '#e0f7fa',
      '--answer-bg': '#b2dfdb',
      '--answer-hover-bg': '#55828b',
      '--correct-bg': '#43e97b', // verde brillante su azzurro/verde acqua
      '--incorrect-bg': '#e63946',
      '--topbar-bg': '#b2dfdb',
      '--text-shadow': '#145374',
      '--title-color': '#145374',
      '--title-shadow': '#b2dfdb',
      '--selected-bg': '#55828b' // blu/verde acceso su azzurro/verde acqua
    },
    'backgrounds/bg7.jpg': {
      '--bg-primary': '#8e44ad',
      '--bg-secondary': '#9b59b6',
      '--text-primary': '#ecf0f1',
      '--text-secondary': '#bdc3c7',
      '--accent-color': '#8e44ad',
      '--button-bg': '#8e44ad',
      '--button-text': '#ffffff',
      '--modal-bg': '#9b59b6',
      '--input-bg': '#8e44ad',
      '--correct-bg': '#43e97b', // verde brillante su viola/spazio
      '--incorrect-bg': '#f9dc5c',
      '--topbar-bg': '#9b59b6',
      '--text-shadow': '#8e44ad',
      '--title-color': '#8e44ad',
      '--title-shadow': '#ffffff',
      '--selected-bg': '#f9dc5c' // giallo acceso su viola/spazio
    }
  };


  // Function to apply background theme
  function applyBackgroundTheme(path) {
    console.log('[applyBackgroundTheme] Called with path:', path);
    const themeToggler = document.getElementById('themeToggle');
    const guestMode = isGuestMode();

    // Clear previous custom palette keys
    const oldPaletteKeys = JSON.parse(localStorage.getItem('currentPaletteKeys') || '[]');
    oldPaletteKeys.forEach(key => document.documentElement.style.removeProperty(key));
    localStorage.setItem('currentPaletteKeys', '[]');
    console.log('[applyBackgroundTheme] Cleared old palette CSS variables.');

    if (guestMode) {
      console.log('[applyBackgroundTheme] Guest mode active. Resetting to default light/dark theme.');
      document.body.style.backgroundImage = '';
      document.body.style.backgroundColor = ''; // Ensure no stray bg color
      document.body.removeAttribute('data-theme'); // Remove custom-bg if present
      
      const themeToRestore = localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.body.setAttribute('data-theme', themeToRestore);
      
      if (themeToggler) {
        themeToggler.style.display = 'inline-block'; // Theme toggle is available for guests
        themeToggler.innerHTML = themeToRestore === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
      }
      // Ensure these are cleared for guests
      localStorage.removeItem('background');
      localStorage.removeItem('themeBeforeBackground');
      updateThemeToggleVisibility(); // Ensure correct visibility state
      return; // Exit early for guests
    }

    Object.keys(document.documentElement.style).forEach(key => {
      if (key.startsWith('--')) {
        document.documentElement.style.removeProperty(key);
      }
    });
    localStorage.setItem('currentPaletteKeys', '[]');
    console.log('[applyBackgroundTheme] Cleared all CSS variables from document.documentElement.style');

    if (path && path !== "null" && path !== "undefined") {
      const palette = BACKGROUND_PALETTES[path];
      if (palette) {
        console.log('[applyBackgroundTheme] Applying background image for:', path);
        console.log('[applyBackgroundTheme] Attempting to apply custom palette:', JSON.stringify(palette));
        document.body.style.backgroundImage = `url(${path})`;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundPosition = 'center';
        document.body.style.backgroundAttachment = 'fixed';

        const newPaletteKeys = [];
        Object.entries(palette).forEach(([key, value]) => {
          document.documentElement.style.setProperty(key, value);
          newPaletteKeys.push(key);
          console.log(`[applyBackgroundTheme] Set ${key} to ${value}. GET: ${document.documentElement.style.getPropertyValue(key)}`);
        });
        localStorage.setItem('currentPaletteKeys', JSON.stringify(newPaletteKeys));
        
        document.body.setAttribute('data-theme', 'custom-bg');
        console.log('[applyBackgroundTheme] Set data-theme to "custom-bg". Current body data-theme:', document.body.getAttribute('data-theme'));
        if (themeToggler) themeToggler.style.display = 'none';
        
        requestAnimationFrame(() => {
          console.log('[applyBackgroundTheme] requestAnimationFrame: Styles should be applied now for custom-bg.');
        });

      } else {
        console.error('[applyBackgroundTheme] No palette found for path:', path, '. Resetting to default theme.');
        // Se la palette non esiste, resetta come se path fosse nullo
        document.body.style.backgroundImage = '';
        document.body.style.backgroundColor = '';
        document.body.removeAttribute('data-theme'); // Rimuovi 'custom-bg' se presente
        const themeToRestore = localStorage.getItem('themeBeforeBackground') || localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.body.setAttribute('data-theme', themeToRestore);
        if (themeToggler) {
          themeToggler.style.display = 'block';
          themeToggler.innerHTML = themeToRestore === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        }
        console.log('[applyBackgroundTheme] Reset to default theme after no palette found:', themeToRestore);
      }
    } else { // Path è nullo, undefined, o stringa "null"/"undefined" -> resetta a tema light/dark
      console.log('[applyBackgroundTheme] Path is invalid or null/undefined, removing custom theme and background.');
      document.body.style.backgroundImage = '';
      document.body.style.backgroundColor = '';
      
      // Ripristina il tema salvato (o quello di default) e mostra il toggler
      const themeToRestore = localStorage.getItem('themeBeforeBackground') || localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      if (document.body.getAttribute('data-theme') === 'custom-bg') {
          document.body.removeAttribute('data-theme'); // Rimuovi custom-bg se presente
      }
      document.body.setAttribute('data-theme', themeToRestore);
      
      if (themeToggler) {
        themeToggler.style.display = 'block';
        themeToggler.innerHTML = themeToRestore === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
      }
      console.log('[applyBackgroundTheme] Applied default theme:', themeToRestore, 'and made themeToggler visible.');
    }
    updateThemeToggleVisibility(); // Assicura coerenza finale
  }

  window.addEventListener('DOMContentLoaded', () => {
    console.log('[DOMContentLoaded] Starting. localStorage snapshot:', JSON.stringify(localStorage));
    updateProfileButtonAvatar();

    const savedBackground = localStorage.getItem('background');
    const currentGuestMode = isGuestMode(); // Check for guest mode here
    console.log('[DOMContentLoaded] localStorage background:', savedBackground, 'Guest Mode:', currentGuestMode);

    if (currentGuestMode) {
      console.log('[DOMContentLoaded] Guest mode detected. Applying default theme via applyBackgroundTheme(null).');
      applyBackgroundTheme(null); // This will correctly set up light/dark for guest
    } else if (savedBackground && savedBackground !== "null" && savedBackground !== "undefined") {
      console.log('[DOMContentLoaded] Valid savedBackground found. Calling applyBackgroundTheme with:', savedBackground);
      applyBackgroundTheme(savedBackground);
      // Forza di nuovo per sicurezza dopo applyBackgroundTheme e attendi un frame
      requestAnimationFrame(() => {
          document.body.setAttribute('data-theme', 'custom-bg');
          console.log('[DOMContentLoaded] requestAnimationFrame: FORCED data-theme to "custom-bg". Current body data-theme:', document.body.getAttribute('data-theme'));
          // Logga lo stato degli stili del container
          const container = document.querySelector('.container');
          if (container) {
              const styles = window.getComputedStyle(container);
              console.log('[DOMContentLoaded] requestAnimationFrame: .container computed background:', styles.backgroundColor);
              console.log('[DOMContentLoaded] requestAnimationFrame: .container computed color:', styles.color);
          }
      });
    } else {
      console.log('[DOMContentLoaded] No valid savedBackground. Applying default theme via applyBackgroundTheme(null).');
      applyBackgroundTheme(null);
    }
    
    console.log('[DOMContentLoaded] Finished initial theme/background logic.');
    
    const classicOptions = document.getElementById('classicOptions');
    if (classicOptions) {
      if (localStorage.getItem('gameMode') === 'classic') {
          classicOptions.style.display = 'block';
      } else {
          classicOptions.style.display = 'none';
      }
    }
    const savedLang = localStorage.getItem('language');
    if (savedLang) {
      const languageSelect = document.getElementById('languageSelect');
      if (languageSelect) languageSelect.value = savedLang;
    }
    applyTranslations();
    
    updateAuthUI();
    updateTopBarVisibility(); // Chiamata aggiunta per coerenza
    updateThemeToggleVisibility(); // Chiamata aggiunta per coerenza

    if (localStorage.getItem('shopJustPaid') === '1') {
      let pollCount = 0;
      const pollInterval = setInterval(() => {
        if (window.socket) {
          window.socket.emit('getProfile');
        } else if (typeof socket !== 'undefined') {
          socket.emit('getProfile');
        }
        pollCount++;
        if (pollCount >= 5) {
          clearInterval(pollInterval);
          localStorage.removeItem('shopJustPaid');
        }
      }, 2000);
    }
  });


  // Function to set background and update backend
  function setBackground(path) {
    if (isGuestMode()) {
      console.log('[setBackground] Guest mode: Operation disabled.');
      // Guests cannot set or unset custom backgrounds. They use the theme toggle for light/dark.
      return;
    }
    const currentBg = localStorage.getItem('background');
    if (currentBg === path) {
      // Se clicchi lo stesso sfondo già attivo, disattiva e torna a chiaro/scuro
      localStorage.removeItem('background');
      document.body.style.backgroundImage = '';
      document.body.style.backgroundColor = '';
      // Ripristina il tema precedente se esiste
      const prevTheme = localStorage.getItem('themeBeforeBackground');
      if (prevTheme) {
        document.body.setAttribute('data-theme', prevTheme);
        localStorage.setItem('theme', prevTheme);
        localStorage.removeItem('themeBeforeBackground');
      }
      applyBackgroundTheme(null);
      // Mostra il selettore chiaro/scuro
      const themeToggler = document.getElementById('themeToggle');
      if (themeToggler) themeToggler.style.display = 'block';
      return;
    }
    if (path) {
      // Salva il tema attuale prima di applicare lo sfondo
      const currentTheme = document.body.getAttribute('data-theme') || localStorage.getItem('theme') || 'light';
      localStorage.setItem('themeBeforeBackground', currentTheme);
      localStorage.setItem('background', path);
      applyBackgroundTheme(path);
      // Nascondi il selettore chiaro/scuro se lo sfondo è attivo
      const themeToggler = document.getElementById('themeToggle');
      if (themeToggler) themeToggler.style.display = 'none';
    } 
  }


  function applyTranslations() {
    const lang = document.getElementById('languageSelect').value || 'en';
    const t = translations[lang] || translations['en'];
    // Esempio: aggiorna testo dei bottoni e placeholder
    document.querySelector('h1').innerText = t.welcome;
    document.getElementById('registerBtn').innerText = t.register;
    document.getElementById('loginBtn').innerText = t.login;
    document.getElementById('continueAsGuestBtn').innerText = t.guest;
    document.getElementById('regUsername').placeholder = t.username;
    document.getElementById('regPassword').placeholder = t.password;
    document.getElementById('regCountry').placeholder = t.country;
    document.getElementById('continueSetup').innerText = t.continue;
    document.getElementById('createLobby').innerText = t.create_lobby;
    document.getElementById('joinLobby').innerText = t.join_lobby;
    document.getElementById('startGameButton').innerText = t.start_game;
    document.querySelector('#playersList h3').innerText = t.players;
    document.getElementById('readyButton').innerText = t.ready;
    document.getElementById('readyStatusText').innerText = t.waiting;
    document.querySelector('#gameOverScreen h2').innerText = t.game_over;
    document.querySelector('#profileModal h2').innerText = t.profile;
    document.getElementById('closeProfileModal').innerText = t.close;
    document.getElementById('logoutButton').innerText = t.logout;
    document.querySelector('#profileLevelXp span').innerHTML = `${t.level}: <span id="profileLevel"></span>`;
    document.querySelector('#profileLevelXp span + .xp-bar + span').innerHTML = `${t.xp}: <span id="profileXp"></span> / <span id="profileXpNext"></span>`;
    // Modifying the .stats innerHTML to include Coins, Gems, and Trophies
    document.querySelector('#profileModal .stats').innerHTML = `
      <span>${t.games_played}: <span id="profileGamesPlayed"></span></span><br>
      <span>${t.victories}: <span id="profileGamesWon"></span></span><br>
      <span>${t.correct}: <span id="profileCorrect"></span></span><br>
      <span>${t.wrong}: <span id="profileWrong"></span></span><br>
      <span>Coins: <span id="profileCoins">0</span></span><br>
      <span>Gems: <span id="profileGems">0</span></span><br>
      <span>${t.trophies || 'Trophies'}: <span id="profileTrophies">0</span></span>
    `;
    document.querySelectorAll('#profileModal p strong')[0].innerText = t.username_label + ':';
    document.querySelectorAll('#profileModal p strong')[1].innerText = t.profile_language + ':';
  
  
  
  
  
  
    // Timer (solo testo iniziale, il resto va aggiornato dinamicamente)
    document.getElementById('timerText').innerText = `${t.time_left}: 10s`;
  }
  document.getElementById('languageSelect').addEventListener('change', () => {
    const lang = document.getElementById('languageSelect').value;
    localStorage.setItem('language', lang);
    applyTranslations();
  });
  window.addEventListener('DOMContentLoaded', () => {
    const savedLang = localStorage.getItem('language');
    if (savedLang) {
      document.getElementById('languageSelect').value = savedLang;
    }
    applyTranslations();
  });
        
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
       themeToggle.addEventListener('click', () => {
  const isDark = body.getAttribute('data-theme') === 'dark';
  const nextTheme = isDark ? 'light' : 'dark';
  body.setAttribute('data-theme', nextTheme);
  localStorage.setItem('theme', nextTheme);
  // Update icon only if not in custom background mode (which guests won't be in)
  if (!document.body.style.backgroundImage || document.body.style.backgroundImage === 'none') {
    themeToggle.innerHTML = nextTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
  }
});
  // Gestisce il click sul pulsante "Continua come Ospite"
document.getElementById('continueAsGuestBtn').addEventListener('click', function() {
  localStorage.setItem('isGuest', 'true');

  // Clear potentially conflicting items from registered user session
  ['token', 'username', 'country', 'language', 'avatar', 'background', 'profileCoins', 'profileGems', 'profileTrophies', 'themeBeforeBackground', 'missionsCycleStart', 'missionsCycleMissions', 'userMissions', 'powerups', 'shopLastFetch', 'dailyShopItems'].forEach(item => localStorage.removeItem(item));
  // Set a default language for guest, can be changed in setup.
  localStorage.setItem('language', 'en'); // Or let them pick in setup

  applyBackgroundTheme(null); // Reset to default light/dark theme for guest
  
  // FORZA LA VISUALIZZAZIONE CORRETTA PER IL GUEST
  const authSection = document.getElementById('authSection');
  const guestButtonSection = document.getElementById('guestSection');
  const forgotPasswordSec = document.getElementById('forgotPasswordSection');
  const setupSection = document.getElementById('setupSection');

  if (authSection) authSection.style.display = 'none';
  if (guestButtonSection) guestButtonSection.style.display = 'none';
  if (forgotPasswordSec) forgotPasswordSec.style.display = 'none';
  if (setupSection) setupSection.style.display = 'block';
  
  // Chiama le funzioni di update UI dopo aver forzato la visualizzazione
  updateAuthUI(); 
  showSetupSection(); // Assicurati che anche questa sia chiamata per popolare i campi giusti
  updateTopBarVisibility();
  updateThemeToggleVisibility();
});
        let username = '';
  let language = 'it';
  let lobbyId = '';
  let countdown = 20;
  let timer;
  let lastAnswerResult = null;
  let isHost = false;
  let gameStarted = false;
  let singlePlayerMode = false;
  let singlePlayerTrophies = 10;
  let category = '';
  let difficulty = '';
  let gameMode = localStorage.getItem('gameMode') || '';
  // --- INIZIO BLOCCO BACK BUTTON ---
  const backButton = document.getElementById('backButton');
  
  
  
  
  
  
  
  
 function updateBackButtonVisibility() {
  const gameVisible = document.getElementById('gameSection').style.display === 'block';
  // Mostra il backButton in tutte le schermate tranne durante il gioco
  backButton.style.display = gameVisible ? 'none' : 'inline-block';
}




// Funzione per mostrare una sezione specifica e nascondere le altre
function showSection(sectionId) {
  const sections = ['setupSection', 'mainMenu'];
  sections.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = (id === sectionId) ? 'block' : 'none';
  });
  updateBackButtonVisibility();
}
  
  
  
  
  
  
  
  
  backButton.addEventListener('click', () => {
    const mainMenuVisible = document.getElementById('mainMenu').style.display === 'block';
    const lobbyVisible = document.getElementById('lobbySection').style.display === 'block';
    const startGameVisible = document.getElementById('startGameSection').style.display === 'block';
    const setupSectionVisible = document.getElementById('setupSection').style.display === 'block';

    if (setupSectionVisible && isGuestMode()) {
      localStorage.removeItem('isGuest');
      localStorage.removeItem('username'); // Clear guest's temporary name
      localStorage.removeItem('language'); // Clear guest's temporary language
      localStorage.removeItem('gameMode');
      updateAuthUI(); // This will show the main login/register/guest screen
      return; 
    }
  
  
  
    if (mainMenuVisible && !lobbyVisible && !startGameVisible) {
      // Sei nel mainMenu "puro", torna alla setupSection
      showSection('setupSection');
    } else if (mainMenuVisible && (lobbyVisible || startGameVisible)) {
      // Sei in una sottosezione del mainMenu, torna al mainMenu "puro"
      document.getElementById('lobbySection').style.display = 'none';
  document.getElementById('startGameSection').style.display = 'none';
  document.getElementById('playersList').style.display = 'none';
  document.getElementById('lobbyCodeDisplay').style.display = 'none';
  
  
  
  
  
  
  
  
      if (!gameStarted) {
        document.getElementById('createLobby').style.display = 'inline-block';
        document.getElementById('joinLobby').style.display = 'inline-block';
      } else {
    document.getElementById('createLobby').style.display = 'none';
    document.getElementById('joinLobby').style.display = 'none';
    }
    updateBackButtonVisibility();
  }
  });
  window.socket = io(); // Made socket global
  const BASE_URL = 'http://localhost:3000/api/auth';
        const profileButton = document.getElementById('profileButton');
      const profileModal = document.getElementById('profileModal');
      const logoutButton = document.getElementById('logoutButton');
      const closeProfileModal = document.getElementById('closeProfileModal');
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
      const languageMap = {
        it: 'Italiano',
        en: 'Inglese',
        fr: 'Francese',
        de: 'Tedesco'
      };
  
  
  
  
    
  // Aggiungi questo event listener
  profileButton.addEventListener('click', () => {
    closeAllModals();
    if (isGuestMode()) return; // Guests cannot access profile modal
    console.log('Profile button clicked'); // Per debug
    window.socket.emit('getProfile');
    profileModal.style.display = 'block';
    focusFirstInput(profileModal);
  });
  
  
  
  
  
  
  
  
  
  
  
  
      // Riceve i dati del profilo e li mostra nel modal
  
  
  
  
  window.socket.on('profileData', (profile) => {
    if (isGuestMode()) return; // Guests don't process profile data

    // Aggiorna sempre il profilo utente globale per il negozio
    window.lastLobbyPlayers = window.lastLobbyPlayers || [{}];
    window.lastLobbyPlayers[0] = Object.assign(window.lastLobbyPlayers[0] || {}, profile);
    console.log('Ricevuti dati profilo:', profile);
    document.getElementById('profileName').innerText = profile.name;
    document.getElementById('profileLanguage').innerText = languageMap[profile.language] || profile.language;
    document.getElementById('profileLevel').innerText = profile.level;
    document.getElementById('profileXp').innerText = profile.xp;
    document.getElementById('profileXpNext').innerText = profile.xpForNextLevel;
    document.getElementById('profileGamesPlayed').innerText = profile.gamesPlayed;
    document.getElementById('profileGamesWon').innerText = profile.gamesWon;
    document.getElementById('profileCorrect').innerText = profile.correctAnswers;
    document.getElementById('profileWrong').innerText = profile.wrongAnswers;
    // Barra XP
    const perc = Math.round((profile.xp / profile.xpForNextLevel) * 100);
    document.getElementById('profileXpBar').style.width = perc + '%';
  
    if (profile.trophies !== undefined) {
      document.getElementById('profileTrophies').innerText = profile.trophies;
    }
    if (profile.coins !== undefined) {
      document.getElementById('profileCoins').innerText = profile.coins;
    }
    // Mostra gemme se presenti
    if (profile.gems !== undefined) {
      document.getElementById('profileGems').innerText = profile.gems;
    }
    // Mostra avatar sbloccati
    const unlockedAvatarsBox = document.getElementById('unlockedAvatarsBox');
    const unlockedAvatars = document.getElementById('unlockedAvatars');
    if (profile.avatars && Array.isArray(profile.avatars) && profile.avatars.length > 0) {
      unlockedAvatarsBox.style.display = 'block';
      unlockedAvatars.innerHTML = '';
      profile.avatars.forEach(img => {
        const avatarImg = document.createElement('img');
        avatarImg.src = img;
        avatarImg.alt = 'avatar';
        avatarImg.style.width = '36px';
        avatarImg.style.height = '36px';
        avatarImg.style.borderRadius = '50%';
        avatarImg.style.border = '2px solid #ccc';
        avatarImg.style.background = '#fff';
        avatarImg.style.cursor = 'pointer';
        avatarImg.onclick = () => setAvatar(img.replace(/^avatars\//, ''));
        unlockedAvatars.appendChild(avatarImg);
      });
    } else {
      unlockedAvatarsBox.style.display = 'none';
      unlockedAvatars.innerHTML = '';
    }
    // Mostra sfondi sbloccati
    const unlockedBackgroundsBox = document.getElementById('unlockedBackgroundsBox');
    const unlockedBackgrounds = document.getElementById('unlockedBackgrounds');
    if (profile.backgrounds && Array.isArray(profile.backgrounds) && profile.backgrounds.length > 0) {
      unlockedBackgroundsBox.style.display = 'block';
      unlockedBackgrounds.innerHTML = '';
      profile.backgrounds.forEach(img => {
        const bgImg = document.createElement('img');
        bgImg.src = img;
        bgImg.alt = 'sfondo';
        bgImg.style.width = '48px';
        bgImg.style.height = '32px';
        bgImg.style.borderRadius = '8px';
        bgImg.style.border = '2px solid #ccc';
        bgImg.style.background = '#fff';
        bgImg.style.cursor = 'pointer';
        bgImg.onclick = () => window.setBackground(img); // Modificato per chiamare window.setBackground
        unlockedBackgrounds.appendChild(bgImg);
      });
    } else {
      unlockedBackgroundsBox.style.display = 'none';
      unlockedBackgrounds.innerHTML = '';
    }
    let percent = 0;
    if (profile.correctAnswers + profile.wrongAnswers > 0) {
      percent = Math.round(100 * profile.correctAnswers / (profile.correctAnswers + profile.wrongAnswers));
    }
    const statsDiv = document.querySelector('#profileModal .stats');
    if (statsDiv) {
      // Rimuovi la riga precedente se esiste
      const oldPercent = document.getElementById('profileCorrectPercentRow');
      if (oldPercent) oldPercent.remove();
      // Aggiungi la riga solo una volta
      const percentRow = document.createElement('span');
      percentRow.id = 'profileCorrectPercentRow';
      percentRow.innerHTML = `<br>Percentuale risposte corrette: <span id="profileCorrectPercent">${percent}%</span>`;
      statsDiv.appendChild(percentRow);
    }


    // Apply background theme if profile has a background set
    if (profile.background) {
      applyBackgroundTheme(profile.background);
    }
    // Alla fine, se la modale shop è aperta, aggiorna la UI
    if (document.getElementById('shopModal') && document.getElementById('shopModal').style.display === 'block') {
      renderShopItems();
    }
  });
  
  
  
  
  
  
  
  
  closeProfileModal.addEventListener('click', () => {
    profileModal.style.display = 'none';
  });
  
  
  
  
  const leaderboardButton = document.getElementById('leaderboardButton');
  const leaderboardModal = document.getElementById('leaderboardModal');
  const closeLeaderboardModal = document.getElementById('closeLeaderboardModal');
  const showNational = document.getElementById('showNational');
  const showGlobal = document.getElementById('showGlobal');
  const leaderboardList = document.getElementById('leaderboardList');
  const yourPosition = document.getElementById('yourPosition');
  
  
  
  
  leaderboardButton.addEventListener('click', () => {
    closeAllModals();
    if (isGuestMode()) return; // Guests cannot access leaderboard
    leaderboardModal.style.display = 'block';
    loadLeaderboard('national');
    startLeaderboardCountdown();
    focusFirstInput(leaderboardModal);
  });
  closeLeaderboardModal.addEventListener('click', () => {
    leaderboardModal.style.display = 'none';
    stopLeaderboardCountdown();
  });
  showNational.addEventListener('click', () => loadLeaderboard('national'));
  showGlobal.addEventListener('click', () => loadLeaderboard('global'));
  
  
  
  
  async function loadLeaderboard(type) {
    const lang = localStorage.getItem('language') || 'it';
    const t = translations[lang] || translations['it'];
    const country = localStorage.getItem('country') || 'IT';
    const username = localStorage.getItem('username');
    let url = '/api/leaderboard/trophies/global';
    let title = t.trophies + " - " + t.scoreboard + " 🌍";
    if (type === 'national') {
      url = `/api/leaderboard/trophies/country/${country}`;
      title = t.trophies + " - " + t.scoreboard + ` (${country})`;
      showNational.classList.add('active');
      showGlobal.classList.remove('active');
    } else {
      showNational.classList.remove('active');
      showGlobal.classList.add('active');
    }
    document.getElementById('leaderboardTitle').innerText = title;
  
  
  
  
    // Se il backend richiede username come query param:
    const res = await fetch(url + '?username=' + encodeURIComponent(username));
    const data = await res.json();
    leaderboardList.innerHTML = '';
    let userInTop = false;
    data.top.forEach((user, i) => {
      const li = document.createElement('li');
      li.textContent = `${i + 1}. ${user.username} (${user.country}) - 🏆 ${user.trophies}`;
      if (user.username === username) {
        li.style.fontWeight = 'bold';
        userInTop = true;
      }
      leaderboardList.appendChild(li);
    });
    // Mostra la posizione dell'utente se non è nei primi 10
    if (!userInTop && data.yourPosition) {
      yourPosition.innerText = `${t.player} ${username} (${country}) - ${t.trophies}: ${data.yourTrophies} | #${data.yourPosition}`;
    } else {
      yourPosition.innerText = '';
    }
  }
  function updateLeaderboardCountdown() {
    const now = new Date();
    let nextReset = new Date(now.getFullYear(), now.getMonth() + 1, 1, 0, 0, 0, 0);
    const diff = nextReset - now;
    if (diff <= 0) {
      document.getElementById('leaderboardCountdown').innerText = '';
      return;
    }
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
    const minutes = Math.floor((diff / (1000 * 60)) % 60);
    const seconds = Math.floor((diff / 1000) % 60);
    document.getElementById('leaderboardCountdown').innerText =
      `⏳ Reset tra: ${days}g ${hours}h ${minutes}m ${seconds}s`;
  }
  
  
  
  
  let leaderboardCountdownInterval = null;
  function startLeaderboardCountdown() {
    updateLeaderboardCountdown();
    leaderboardCountdownInterval = setInterval(updateLeaderboardCountdown, 1000);
  }
  function stopLeaderboardCountdown() {
    clearInterval(leaderboardCountdownInterval);
  }
  
  
  
  
  
  
  
  
      logoutButton.addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('username');
        localStorage.removeItem('country');
        localStorage.removeItem('language');
        localStorage.removeItem('isGuest'); 
        localStorage.removeItem('avatar');
        localStorage.removeItem('background'); // Rimosso lo sfondo da localStorage

        // Resetta avatar nella UI
        if (document.getElementById('profileAvatar')) {
          document.getElementById('profileAvatar').src = 'avatars/avatar1.png';
        }
        
        // Chiama applyBackgroundTheme(null) per un reset completo del tema e dello sfondo
        applyBackgroundTheme(null); 
        // applyBackgroundTheme(null) si occuperà di:
        // 1. Rimuovere le variabili CSS della palette personalizzata da document.documentElement
        // 2. Impostare body.style.backgroundImage e backgroundColor a ''
        // 3. Impostare il data-theme corretto ('light' o 'dark')
        // 4. Mostrare il themeToggle e aggiornarne l'icona

        updateTopBarVisibility(); // Assicurati che la top bar sia aggiornata
        updateAuthUI(); // Mostra la schermata di login/registrazione dopo il logout
        updateThemeToggleVisibility();
      });
  function updateAuthUI() {
    const token = localStorage.getItem('token');
    const guestMode = isGuestMode();
    const setupSection = document.getElementById('setupSection');
    const authSectionEl = document.getElementById('authSection'); // Renamed to avoid conflict
    const guestButtonSection = document.getElementById('guestSection');
    const forgotPasswordSec = document.getElementById('forgotPasswordSection');
    const mainMenu = document.getElementById('mainMenu');

    if (guestMode) {
      if (authSectionEl) authSectionEl.style.display = 'none';
      if (guestButtonSection) guestButtonSection.style.display = 'none';
      if (forgotPasswordSec) forgotPasswordSec.style.display = 'none';
      showSetupSection(); 
    } else if (token) {
      if (authSectionEl) authSectionEl.style.display = 'none';
      if (guestButtonSection) guestButtonSection.style.display = 'none';
      if (forgotPasswordSec) forgotPasswordSec.style.display = 'none';
      showSetupSection();
    } else {
      if (authSectionEl) authSectionEl.style.display = 'block';
      if (guestButtonSection) guestButtonSection.style.display = 'block';
      if (setupSection) setupSection.style.display = 'none';
      if (mainMenu) mainMenu.style.display = 'none';
      if (forgotPasswordSec && forgotPasswordSec.style.display !== 'block') {
          forgotPasswordSec.style.display = 'none';
      }
    }
    updateTopBarVisibility(); 
    updateThemeToggleVisibility(); 
  }
  window.addEventListener('DOMContentLoaded', () => {
    updateAuthUI();
  });
  document.getElementById('setupSection').style.display = 'none';
  document.getElementById('mainMenu').style.display = 'none';
  if (localStorage.getItem('token')) {
    showSetupSection(); // Se utente già loggato
  } else if (isGuestMode()) {
    showSetupSection(); // If guest mode is somehow active on load without token
  }
  function showSetupSection() {
    const guestMode = isGuestMode();
    document.getElementById('authSection').style.display = 'none';
    document.getElementById('guestSection').style.display = 'none'; 
    document.getElementById('forgotPasswordSection').style.display = 'none';
    document.getElementById('setupSection').style.display = 'block';

    if (guestMode) {
      document.getElementById('usernameInput').value = ''; 
      document.getElementById('languageSelect').value = localStorage.getItem('language') || 'en';
      // Potentially hide or disable country input for guests here if it exists in the form
      // e.g., if (document.getElementById('countrySetupInput')) document.getElementById('countrySetupInput').style.display = 'none';
    } else {
      // Logged-in user
      document.getElementById('usernameInput').value = localStorage.getItem('username') || '';
      document.getElementById('languageSelect').value = localStorage.getItem('language') || 'it';
    }

    const usernameFromStorage = localStorage.getItem('username');
    if (!guestMode && usernameFromStorage) {
      window.socket.emit('setUser', { username: usernameFromStorage });
      window.socket.emit('getProfile');
    } else if (guestMode) {
      updateProfileButtonAvatar(); // show guest avatar
    }
  }
  // Quando clicchi "Continua" dopo aver inserito il nome utente
  document.getElementById('continueSetup').onclick = () => {
    const lang = document.getElementById('languageSelect').value || 'en';
    const t = translations[lang] || translations['en'];
    const guestMode = isGuestMode();
    const mode = document.getElementById('modeSelect').value;
    if (!mode) {
      alert('Seleziona una modalità di gioco!');
      return;
    }
    gameMode = mode;
    localStorage.setItem('gameMode', gameMode);

    const nameInput = document.getElementById('usernameInput').value.trim();
    console.log('Valore inserito:', nameInput);
    if (!nameInput) {
      alert(t.enter_name);
      return;
    }
    const langSelect = document.getElementById('languageSelect').value;
    category = document.getElementById('categorySelect').value;
    difficulty = document.getElementById('difficultySelect').value;
    if (!nameInput) {
      alert(t.enter_name);
      return;
    }
    // Salva i dati dell'utente nel localStorage per usarli dopo
    username = nameInput;
    language = langSelect;
    localStorage.setItem('username', username);
    localStorage.setItem('language', language);
    showSection('mainMenu');
    window.socket.emit('setUser', { username, gameMode });
  };
  function showFormError(formId, message) {
    const errorContainer = document.getElementById(formId + "Error");
    if (!errorContainer) return;
    errorContainer.textContent = message;
    errorContainer.classList.add("show");
  }
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  function hideFormError(formId) {
    const errorContainer = document.getElementById(formId + "Error");
    if (!errorContainer) return;
    errorContainer.textContent = "";
    errorContainer.classList.remove("show");
  }
  document.getElementById('registerBtn').onclick = async () => {
    localStorage.removeItem('isGuest'); // Clear guest mode if trying to register
    const username = document.getElementById('regUsername').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const password = document.getElementById('regPassword').value;
    const country = document.getElementById('regCountry').value.trim();
   
    // Validazione email base
    if (!username || !email || !password || !country) {
      showFormError("register", 'Compila tutti i campi per registrarti!');
      return;
    }
    // Regex semplice per email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      showFormError("register", 'Inserisci un indirizzo email valido!');
      return;
    }
   
    try {
      const res = await fetch(`${BASE_URL}/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, email, password, country })
      });
     
      const data = await res.json();
      if (res.ok) {
        localStorage.setItem('token', data.token);
        localStorage.setItem('username', data.username);
        localStorage.setItem('country', data.country);
        hideFormError("register");  // Rimuove eventuali messaggi di errore precedenti
        showSetupSection();
        window.socket.emit('setUser', { username: data.username });
        window.socket.emit('getProfile');
        onLoginSuccess();
      } else {
        showFormError("register", data.error || 'Errore nella registrazione');
      }
    } catch (err) {
      console.error(err);
      showFormError("register", 'Errore di connessione');
    }
  };
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  document.getElementById('loginBtn').onclick = async () => {
    localStorage.removeItem('isGuest'); // Clear guest mode if trying to login
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
   
    if (!username || !password) {
      showFormError("login", 'Inserisci username e password!');
      return;
    }
   
    try {
      const res = await fetch(`${BASE_URL}/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
     
      const data = await res.json();
      if (res.ok) {
        localStorage.setItem('token', data.token);
        localStorage.setItem('username', data.username);
        localStorage.setItem('country', data.country);
        hideFormError("login");  // Rimuove eventuali errori
        showSetupSection();
        window.socket.emit('setUser', { username: data.username }); 
        window.socket.emit('getProfile');
        onLoginSuccess();
      } else {
        showFormError("login", data.error || 'Errore nel login');
      }
    } catch (err) {
      console.error(err);
      showFormError("login", 'Errore di connessione');
    }
  };
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  function showSetupSection() {
    const guestMode = isGuestMode();
    document.getElementById('authSection').style.display = 'none';
    document.getElementById('guestSection').style.display = 'none';
    document.getElementById('forgotPasswordSection').style.display = 'none';
    document.getElementById('setupSection').style.display = 'block';
    
    if (guestMode) {
        document.getElementById('usernameInput').value = localStorage.getItem('username') || ''; // Guest might have a temp name
        document.getElementById('languageSelect').value = localStorage.getItem('language') || 'en';
    } else {
        document.getElementById('usernameInput').value = localStorage.getItem('username');
        document.getElementById('languageSelect').value = localStorage.getItem('language') || 'it';
    }
  
  
  
    const username = localStorage.getItem('username');
    if (username) {
      window.socket.emit('setUser', { username });
      window.socket.emit('getProfile');
    }
  }
        document.getElementById('continueSetup').onclick = () => {
          const lang = document.getElementById('languageSelect').value || 'en';
          const t = translations[lang] || translations['en'];
          const guestMode = isGuestMode();
          const mode = document.getElementById('modeSelect').value;
          if (!mode) {
            alert('Seleziona una modalità di gioco!');
            return;
          }
          gameMode = mode;
          localStorage.setItem('gameMode', gameMode);

          const nameInput = document.getElementById('usernameInput').value.trim();
          const langSelect = document.getElementById('languageSelect').value;
          category = document.getElementById('categorySelect').value;
          difficulty = document.getElementById('difficultySelect').value;
          if (!nameInput) {
            alert(t.enter_name);
            return;
          }
          username = nameInput;
          language = langSelect;
          localStorage.setItem('username', username);
          localStorage.setItem('language', language);
          showSection('mainMenu');
          window.socket.emit('setUser', { username, gameMode });
          window.socket.emit('getProfile');
        };
        document.getElementById('createLobby').onclick = () => {
    const guestMode = isGuestMode();
    const storedUsername = localStorage.getItem('username');
    const storedLanguage = localStorage.getItem('language');
    const storedGameMode = localStorage.getItem('gameMode');

    // Validate that essential data is present, especially for guests
    if (guestMode && (!storedUsername || !storedLanguage || !storedGameMode)) {
        alert("Si è verificato un errore con i dati della sessione ospite. Per favore, torna indietro e reinserisci nome e modalità.");
        // Optionally, redirect to setup:
        // showSection('setupSection'); 
        return;
    }

    const country = guestMode ? '' : (localStorage.getItem('country') || '');
    
    // category and difficulty are still from global scope, set in continueSetup
    // Ensure they are defined, defaulting to empty string if not (though setup should handle this)
    const currentCategory = typeof category !== 'undefined' ? category : '';
    const currentDifficulty = typeof difficulty !== 'undefined' ? difficulty : '';

    // DEBUG: stampa i dati che stai per inviare al server per la creazione della lobby
    console.log('[DEBUG][createLobby] Invio dati al server:', {
        username: storedUsername,
        language: storedLanguage,
        country: country,
        category: currentCategory,
        difficulty: currentDifficulty,
        gameMode: storedGameMode,
        isGuest: guestMode
    });
    window.socket.emit('createLobby', { 
        username: storedUsername, 
        language: storedLanguage, 
        country: country, 
        category: currentCategory, 
        difficulty: currentDifficulty, 
        gameMode: storedGameMode, 
        isGuest: guestMode 
    });
    
    document.getElementById('createLobby').style.display = 'none';
    document.getElementById('joinLobby').style.display = 'none';

    const tournamentBtn = document.getElementById('tournamentBtn');
    if (tournamentBtn) tournamentBtn.style.display = 'none';
    
    const challengeFriendBtn = document.getElementById('challengeFriendBtn');
    if (challengeFriendBtn) challengeFriendBtn.style.display = 'none';

    // Attempt to hide Tutorial and Share buttons with assumed IDs
    const mainMenuTutorialButton = document.getElementById('mainMenuTutorialButton');
    if (mainMenuTutorialButton) mainMenuTutorialButton.style.display = 'none';

    const mainMenuShareButton = document.getElementById('mainMenuShareButton');
    if (mainMenuShareButton) mainMenuShareButton.style.display = 'none';
    
    // The UI update for a successful lobby creation (showing lobby code, start game button) 
    // will be handled by the 'socket.on('lobbyCreated', ...)' listener.
  }; // This was the missing closing brace
        document.getElementById('joinLobby').onclick = () => {
          showSection('mainMenu');
          document.getElementById('lobbySection').style.display = 'block';
    document.getElementById('startGameSection').style.display = 'none';
    document.getElementById('playersList').style.display = 'none';
    document.getElementById('lobbyCodeDisplay').style.display = 'none';
  
  
  
  
          if (!gameStarted) {
        document.getElementById('createLobby').style.display = 'inline-block';
        document.getElementById('joinLobby').style.display = 'inline-block';
      } else {
    document.getElementById('createLobby').style.display = 'none';
    document.getElementById('joinLobby').style.display = 'none';
    }
    updateBackButtonVisibility();
  }
  
        window.socket.on('lobbyCreated', (newLobbyId) => {
    console.log('[DEBUG][lobbyCreated] Evento ricevuto dal server! newLobbyId:', newLobbyId);
    lobbyId = newLobbyId;
    isHost = true;
    gameStarted = false;
    // Mostra il codice lobby nella UI
    const lobbyCodeDisplay = document.getElementById('lobbyCodeDisplay');
    const lobbyCode = document.getElementById('lobbyCode');
    lobbyCode.textContent = lobbyId;
    lobbyCodeDisplay.style.display = 'block';
    // Nascondi i bottoni iniziali
    document.getElementById('createLobby').style.display = 'none';
    document.getElementById('joinLobby').style.display = 'none';
    document.getElementById('lobbySection').style.display = 'none';
    // Mostra la sezione per iniziare il gioco se l'utente è l'host
    if (isHost && !gameStarted) {
      document.getElementById('startGameSection').style.display = 'block';
    }
  });
        window.socket.on('joinedLobbyState', ({ lobbyId: joinedLobby, gameStarted: alreadyStarted }) => {
          lobbyId = joinedLobby;
          document.getElementById('createLobby').style.display = 'none';
          document.getElementById('joinLobby').style.display = 'none';
          document.getElementById('lobbySection').style.display = 'none';
          gameStarted = alreadyStarted;
          if (gameStarted) {
            document.getElementById('startGameSection').style.display = 'none';
          } else {
            if (isHost) {
              document.getElementById('startGameSection').style.display = 'block';
            }
          }
        });
        window.socket.on('lobbyPlayers', (players) => {
          window.lastLobbyPlayers = players;
          const ul = document.getElementById('playersUl');
          ul.innerHTML = '';
          players.forEach(player => {
            const li = document.createElement('li');
            li.id = `player-${player.id}`;
            // Mostra avatar cartoon accanto al nome
            const avatarUrl = getAvatarForUser(player);
            li.innerHTML = `<img src="${avatarUrl}" alt="avatar" style="width:32px;height:32px;border-radius:50%;vertical-align:middle;margin-right:8px;border:2px solid #ccc;background:#fff;"> ${player.name} (${player.language})`;
            ul.appendChild(li);
          });
          if (!gameStarted) {
            document.getElementById('playersList').style.display = 'block';
          }
        });
        document.getElementById('startGameButton').onclick = () => {
          const maxQuestions = parseInt(document.getElementById('questionCount').value);
          window.socket.emit('startGame', { lobbyId, maxQuestions, language });
          gameStarted = true;
          window.gameStarted = true;
          document.getElementById('startGameSection').style.display = 'none';
          document.getElementById('playersList').style.display = 'none';
          document.getElementById('lobbySection').style.display = 'none';
          document.getElementById('lobbyCodeDisplay').style.display = 'none';
          document.getElementById('gameSection').style.display = 'block';
          document.getElementById('timerText').style.display = 'none';
          updateBackButtonVisibility();
          document.getElementById('tournamentBtn').style.display = 'none';
          document.getElementById('challengeFriendBtn').style.display = 'none';
          document.getElementById('createLobby').style.display = 'none';
          document.getElementById('joinLobby').style.display = 'none';
          updateLobbyChatVisibility(); // <--- aggiungi questa riga
        };
        let currentQuestionNumber = 0;  // Iniziamo da 0, ma resetteremo a 1 all'inizio della partita
  // Funzione che viene chiamata quando una nuova partita inizia
  function startNewGame() {
    currentQuestionNumber = 1;  // Iniziamo la partita con la domanda 1
    // Altre logiche di reset, se necessario
    document.getElementById('scoreText').style.display = 'none';
    document.getElementById('playersList').style.display = 'none';
    document.getElementById('gameOverScreen').style.display = 'none';
    document.getElementById('gameSection').style.display = 'block';
  }
  
  
  
  
  // Utility per nascondere/mostrare il pulsante Prosegui
  function showNextQuestionBtn(show) {
    const btn = document.getElementById('nextQuestionBtn');
    btn.style.display = show ? 'inline-block' : 'none';
    if (show) btn.disabled = false;
  }
  
  
  
  
  window.socket.on('newQuestion', (questionData) => {
    selectedAnswerText = null; // resetta per la nuova domanda
    console.log('Ricevuta domanda:', questionData);
    document.getElementById('gameSection').style.display = 'block';
  document.getElementById('playersList').style.display = 'none';
  document.getElementById('gameOverScreen').style.display = 'none';
  document.getElementById('timerText').style.display = 'block';
  
  
  
  
    // Incrementiamo il numero della domanda
    currentQuestionNumber++;  
    // Nascondiamo le altre sezioni
    document.getElementById('playersList').style.display = 'none';
    document.getElementById('gameOverScreen').style.display = 'none';
   
    // Mostriamo il numero della domanda seguito dalla parentesi e dalla domanda
    document.getElementById('questionText').innerText = `${currentQuestionNumber}) ${questionData.question}`;
    // Mostra immagine se presente
    if (questionData.imageUrl) {
      let img = document.getElementById('questionImage');
      if (!img) {
        img = document.createElement('img');
        img.id = 'questionImage';
        img.style.maxWidth = '300px';
        document.getElementById('questionText').after(img);
      }
      img.src = questionData.imageUrl;
      img.style.display = 'block';
    } else {
      const img = document.getElementById('questionImage');
      if (img) img.style.display = 'none';
    }
    // Nascondiamo il punteggio iniziale
    document.getElementById('scoreText').style.display = 'none';
    // Mescoliamo le risposte
    const answers = [...questionData.incorrect_answers, questionData.correct_answer];
    const shuffled = answers.sort(() => Math.random() - 0.5);
    const answersList = document.getElementById('answersList');
    answersList.innerHTML = '';
    shuffled.forEach(answer => {
      const button = document.createElement('button');
      button.classList.add('answer-button');
      button.innerText = answer;
      button.onclick = () => {
        button.classList.add('selected');
        window.socket.emit('submitAnswer', { lobbyId: lobbyId, answer });
        disableOtherAnswers();
      };
      answersList.appendChild(button);
    });
    singlePlayerMode = !!questionData.singlePlayerMode;
    if (singlePlayerMode && typeof questionData.singlePlayerTrophies === 'number') {
      singlePlayerTrophies = questionData.singlePlayerTrophies;
    }
    showNextQuestionBtn(singlePlayerMode); // mostra solo se single player
    document.getElementById('singlePlayerTrophiesBox').style.display = singlePlayerMode ? 'block' : 'none';
    document.getElementById('nextQuestionBtn').disabled = false; // <--- RIABILITA SEMPRE
    if (singlePlayerMode) {
      document.getElementById('singlePlayerTrophies').innerText = singlePlayerTrophies;
    }
    // Iniziamo il countdown
    countdown = 20;
    document.getElementById('timerText').innerText = `Tempo rimanente: ${countdown}s`;
    clearInterval(timer);
    timer = setInterval(updateTimer, 1000);
    updateTimerBar();
  
  
  
  
    if (singlePlayerMode) {
      window.socket.emit('usePowerUp', { lobbyId, type: 'status' });
    } else {
      document.getElementById('powerUps').style.display = 'none';
    }
    updateGameChatVisibility();
    updateLobbyChatVisibility(); // <--- aggiungi questa riga
  });
        function disableOtherAnswers() {
          if (singlePlayerMode) {
            return;
          }
          const buttons = document.querySelectorAll('.answer-button');
          buttons.forEach(button => {
            button.disabled = true;
          });
        }
        function updateTimerBar() {
          const timerBar = document.getElementById('timerBar');
          if (!timerBar) return;
          const percent = (countdown / 20) * 100;
          timerBar.style.width = percent + '%';
        }
        function updateTimer() {
          const lang = document.getElementById('languageSelect').value || 'en';
          const t = translations[lang] || translations['en'];
          if (countdown > 0) {
      countdown--;
      document.getElementById('timerText').innerText = `${t.time_left}: ${countdown}s`;
      updateTimerBar();
    } else {
      clearInterval(timer);
      document.getElementById('timerText').innerText = t.time_up;
      updateTimerBar();
         
          if (lastAnswerResult !== null) {
              playSound('timeout');
              alert(lastAnswerResult.correct ? t.correct_answer : t.wrong_answer);
              lastAnswerResult = null;
            }
      }
  }
        let selectedAnswerText = null;
  const sounds = {
    correct: new Audio('sounds/correct.mp3'),
    wrong: new Audio('sounds/wrong.mp3'),
    timeout: new Audio('sounds/timeout.mp3')
  };
  function playSound(type) {
    if (sounds[type]) {
      sounds[type].currentTime = 0;
      sounds[type].play();
    }
  }
  window.socket.on('answerResult', (result) => {
    selectedAnswerText = result.selected_answer;
    const answerButtons = document.querySelectorAll('.answer-button');
    answerButtons.forEach(button => {
      if (button.innerText === selectedAnswerText) {
        button.classList.add('selected');
      }
      button.disabled = true;
    });
    playSound(result.correct ? 'correct' : 'wrong');
    updateMissionsOnAnswer({ correct: result.correct, category: result.category });
  });
  document.getElementById('answersList').onclick = function(e) {
    if (!singlePlayerMode) return;
    if (e.target && e.target.classList.contains('answer-button')) {
      const answer = e.target.innerText;
      selectedAnswerText = answer; // <-- salva sempre la risposta selezionata
      window.socket.emit('submitAnswer', { lobbyId, answer });
      document.querySelectorAll('.answer-button').forEach(btn => btn.classList.remove('selected'));
      e.target.classList.add('selected');
      // NON disabilitare i bottoni!
    }
  };
  window.socket.on('showCorrectAnswer', ({ correct_answer }) => {
    const buttons = document.querySelectorAll('.answer-button');
    buttons.forEach(btn => {
      const btnText = btn.innerText;
      btn.classList.remove('selected');
      // In single player, evidenzia la risposta selezionata in rosso se sbagliata
      if (singlePlayerMode && selectedAnswerText && btnText === selectedAnswerText && btnText !== correct_answer) {
        btn.classList.add('incorrect');
      }
      if (btnText === correct_answer) {
        btn.classList.add('correct');
      }
      btn.disabled = true;
    });
    selectedAnswerText = null;
  });
  window.socket.on('scoreboard', (scores) => {
    const lang = document.getElementById('languageSelect').value || 'en';
    const t = translations[lang] || translations['en'];
    const scoreboardScreen = document.getElementById('scoreboardScreen');
    const questionText = document.getElementById('questionText');
    const answersList = document.getElementById('answersList');
    const timerText = document.getElementById('timerText');
  
  
  
  
      questionText.style.display = 'none';
    answersList.style.display = 'none';
    timerText.style.display = 'none';
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    scoreboardScreen.innerHTML = `<h2>${t.scoreboard}</h2>`;
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    scores.sort((a, b) => b.score - a.score);
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    scores.forEach((score, index) => {
      const playerScore = document.createElement('div');
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
      let medal = '';
      if (index === 0) {
        medal = '🥇';
        playerScore.className = 'podium-first';
      } else if (index === 1) {
        medal = '🥈';
        playerScore.className = 'podium-second';
      } else if (index === 2) {
        medal = '🥉';
        playerScore.className = 'podium-third';
      } else {
        playerScore.className = 'scoreboard-player';
      }
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
      const avatarUrl = getAvatarForUser(score);
      playerScore.innerHTML = `${medal} <img src="${avatarUrl}" alt="avatar" style="width:28px;height:28px;border-radius:50%;vertical-align:middle;margin-right:6px;border:2px solid #ccc;background:#fff;"> ${index + 1}. ${score.name} - ${score.score} ${t.score}`;
      scoreboardScreen.appendChild(playerScore);
    });
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    scoreboardScreen.classList.remove('fade-out');
    scoreboardScreen.classList.add('fade-in');
    scoreboardScreen.style.display = 'block';
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    // Nascondi il pulsante Prosegui durante la classifica in single player
    if (singlePlayerMode) showNextQuestionBtn(false);
  
  
  
  
    setTimeout(() => {
      scoreboardScreen.classList.remove('fade-in');
      scoreboardScreen.classList.add('fade-out');
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
      setTimeout(() => {
        scoreboardScreen.style.display = 'none';
        questionText.style.display = 'block';
        answersList.style.display = 'block';
        timerText.style.display = 'block';
        // Ri-mostra il pulsante Prosegui solo se single player e c'è una domanda
        if (singlePlayerMode) showNextQuestionBtn(true);
      }, 1000);
    }, 5000);
    // Aggiorna trofei single player se presenti
    if (singlePlayerMode && scores.length === 1 && typeof scores[0].singlePlayerTrophies === 'number') {
      singlePlayerTrophies = scores[0].singlePlayerTrophies;
      document.getElementById('singlePlayerTrophies').innerText = singlePlayerTrophies;
    }
  });
  document.getElementById('nextQuestionBtn').onclick = function() {
    window.socket.emit('nextQuestionRequest', { lobbyId });
    document.getElementById('nextQuestionBtn').disabled = true;
  };
        window.socket.on('gameOver', ({ message, finalScores, singlePlayerMode: spm }) => {
          document.getElementById('gameSection').style.display = 'none';
          document.getElementById('gameOverScreen').style.display = 'block';
          const finalScoresList = document.getElementById('finalScores');
          finalScoresList.innerHTML = '';
          const guestMode = isGuestMode(); // Check guest mode

          finalScores.forEach(player => {
            const avatarUrl = getAvatarForUser(player);
            const li = document.createElement('li');
            li.innerHTML = `<img src="${avatarUrl}" alt="avatar" style="width:28px;height:28px;border-radius:50%;vertical-align:middle;margin-right:6px;border:2px solid #ccc;background:#fff;"> ${t.player} ${player.name} (${player.language}) - ${t.score}: ${player.score}`;
            finalScoresList.appendChild(li);
          });

          if (!guestMode) { // Only for logged-in users
            loadLeaderboard('national');
            loadLeaderboard('global');
            window.socket.emit('getProfile');
            // Aggiorna trofei single player anche qui
            if (spm && finalScores.length === 1 && typeof finalScores[0].singlePlayerTrophies === 'number') {
              singlePlayerTrophies = finalScores[0].singlePlayerTrophies;
              document.getElementById('singlePlayerTrophies').innerText = singlePlayerTrophies;
            }
            const myUsername = localStorage.getItem('username');
            if (finalScores && finalScores.length && finalScores[0].name === myUsername) {
              updateMissionsOnWin();
            }
          }
          // Share button should be visible for guests too
        });
        let isReady = false;
        document.getElementById('readyButton').onclick = () => {
          window.socket.emit('playerReady', lobbyId);
          document.getElementById('readyButton').disabled = true;
          document.getElementById('readyStatusText').innerText = "In attesa degli altri giocatori...";
          isReady = true;
        };
        window.socket.on('updateReadyStatus', (readyCount, totalPlayers) => {
          document.getElementById('readyStatusText').innerText = `${t.players_ready}: ${readyCount}/${totalPlayers}`;
        });
        window.socket.on('restartGame', () => {
    isReady = false;
    currentQuestionNumber = 0;
    document.getElementById('readyButton').disabled = false;
    document.getElementById('readyStatusText').innerText = '';
    document.getElementById('gameOverScreen').style.display = 'none';
    document.getElementById('startGameSection').style.display = isHost ? 'block' : 'none';
  });
  document.getElementById('returnToMainMenuButton').onclick = () => {
    document.getElementById('gameOverScreen').style.display = 'none';
    showSection('mainMenu');
  
  
  
  
    document.getElementById('setupSection').style.display = 'none';
    document.getElementById('lobbySection').style.display = 'none';
    document.getElementById('startGameSection').style.display = 'none';
    document.getElementById('gameSection').style.display = 'none';
    // Se non sei in una challenge, mostra i pulsanti e input
    if (!window.lobbyId || !window.lastLobbyPlayers || window.lastLobbyPlayers.length !== 2) {
      document.getElementById('createLobby').style.display = 'inline-block';
      document.getElementById('joinLobby').style.display = 'inline-block';
      document.getElementById('tournamentBtn').style.display = 'inline-block';
      document.getElementById('challengeFriendBtn').style.display = 'inline-block';
      document.getElementById('lobbyIdInput').style.display = '';
      document.getElementById('joinLobbyButton').style.display = '';
    }
    updateLobbyChatVisibility(); // <--- aggiungi questa riga
  };
  
  
  
  
  // Power-up click handler
  document.getElementById('power5050').onclick = function() {
    if (isGuestMode()) return; // Guests cannot use power-ups
    window.socket.emit('usePowerUp', { lobbyId, type: '5050' });
  };
  document.getElementById('powerSkip').onclick = function() {
    if (isGuestMode()) return;
    window.socket.emit('usePowerUp', { lobbyId, type: 'skip' });
  };
  document.getElementById('powerTime').onclick = function() {
    if (isGuestMode()) return;
    window.socket.emit('usePowerUp', { lobbyId, type: 'time' });
  };
  
  
  
  
  // Mostra/nasconde i pulsanti power-up in base allo stato ricevuto dal server
  window.socket.on('powerUpStatus', (data) => {
    if (isGuestMode()) {
        document.getElementById('powerUps').style.display = 'none';
        return;
    }
    const box = document.getElementById('powerUps');
    if (singlePlayerMode) {
      box.style.display = 'block';
      document.getElementById('power5050').style.display = data.available['5050'] ? 'inline-block' : 'none';
      document.getElementById('powerSkip').style.display = data.available['skip'] ? 'inline-block' : 'none';
      document.getElementById('powerTime').style.display = data.available['time'] ? 'inline-block' : 'none';
    } else {
      box.style.display = 'none';
    }
  });
  
  
  
  
  // Ricevi effetto power-up
  window.socket.on('powerUpResult', (data) => {
    if (data.type === '5050' && Array.isArray(data.keepAnswers)) {
      document.querySelectorAll('.answer-button').forEach(btn => {
        if (!data.keepAnswers.includes(btn.innerText)) btn.style.visibility = 'hidden';
      });
    }
    // Aggiorna countdown e UI se power-up tempo extra
    if (data.type === 'time' && typeof data.newTime === 'number') {
      countdown = data.newTime;
      document.getElementById('timerText').innerText = `Tempo rimanente: ${countdown}s`;
    }
  });
  
  
  
  
  // Mostra/nasconde le opzioni classiche in base alla modalità selezionata
  document.getElementById('modeSelect').addEventListener('change', function() {
    gameMode = this.value;
    localStorage.setItem('gameMode', gameMode);
    document.getElementById('classicOptions').style.display = (this.value === 'classic') ? 'block' : 'none';
  });
  
  
  // Mostra le opzioni se già salvato in localStorage
  window.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('gameMode') === 'classic') {
      document.getElementById('classicOptions').style.display = 'block';
    } else {
      document.getElementById('classicOptions').style.display = 'none';
    }
  });
  
  
  // --- CHALLENGE FRIEND LOGIC ---
  
  
  window.addEventListener('DOMContentLoaded', function() {
    document.getElementById('challengeFriendBtn').onclick = function() {
      closeAllModals();
      showFriendsModal(false); // Apri direttamente la lista amici
      focusFirstInput(document.getElementById('friendsModal'));
    };
    document.getElementById('closeChallengeModal').onclick = function() {
      document.getElementById('challengeModal').style.display = 'none';
    };
    document.getElementById('sendChallengeBtn').onclick = function() {
      const friendUsername = document.getElementById('challengeUsernameInput').value.trim();
      if (!friendUsername) {
        document.getElementById('challengeError').innerText = "Inserisci il nome utente!";
        document.getElementById('challengeError').style.display = 'block';
        return;
      }
      window.socket.emit('challengeFriend', { to: friendUsername, from: localStorage.getItem('username') });
      document.getElementById('challengeError').innerText = "Invito inviato!";
      document.getElementById('challengeError').style.display = 'block';
    };
    document.getElementById('closeInvitesModal').onclick = function() {
      document.getElementById('challengeInvitesModal').style.display = 'none';
    };
  });
  
  
  // Mostra la modale amici
  document.getElementById('friendsButton').onclick = function() {
    closeAllModals();
    if (isGuestMode()) return; // Guests cannot access friends
    showFriendsModal();
    focusFirstInput(document.getElementById('friendsModal'));
  };
  
  
  // Chiudi modale amici
  document.getElementById('closeFriendsModal').onclick = function() {
    document.getElementById('friendsModal').style.display = 'none';
    friendsBadgeCount = 0;
    updateFriendsBadge();
  };
  
  
  // --- FRIENDS UI TABS LOGIC ---
  document.getElementById('showFriendsListTab').onclick = function() {
    document.getElementById('friendsListSection').style.display = 'block';
    document.getElementById('friendsNotificationsSection').style.display = 'none';
    this.classList.add('active');
    document.getElementById('showFriendsNotificationsTab').classList.remove('active');
  };
  document.getElementById('showFriendsNotificationsTab').onclick = function() {
    document.getElementById('friendsListSection').style.display = 'none';
    document.getElementById('friendsNotificationsSection').style.display = 'block';
    this.classList.add('active');
    document.getElementById('showFriendsListTab').classList.remove('active');
  };
  
  
  // Mostra la modale amici e aggiorna lista amici e notifiche
  function showFriendsModal(openNotifications = false) {
    document.getElementById('friendsModal').style.display = 'block';
    // Tab switch
    if (openNotifications) {
      document.getElementById('showFriendsNotificationsTab').click();
    } else {
      document.getElementById('showFriendsListTab').click();
    }
    // Lista amici
    const ul = document.getElementById('friendsList');
    ul.innerHTML = '';
    friends.forEach(friend => {
      const li = document.createElement('li');
      li.innerHTML = `
        <span>${friend}</span>
        <button onclick="challengeThisFriend('${friend}')">Sfida</button>
      `;
      ul.appendChild(li);
    });
    // Notifiche inviti
    updateFriendsInvitesList();
    friendsBadgeCount = 0;
    updateFriendsBadge();
    focusFirstInput(document.getElementById('friendsModal'));
  }
  
  
  // Aggiorna la lista notifiche inviti nella modale amici
  function updateFriendsInvitesList() {
    const ul = document.getElementById('friendsInvitesList');
    ul.innerHTML = '';
    challengeInvites.forEach(invite => {
      const li = document.createElement('li');
      li.innerHTML = `
        <span>${invite.from} ti ha sfidato!</span>
        <span>
          <button onclick="acceptChallenge('${invite.from}')">Accetta</button>
          <button onclick="rejectChallenge('${invite.from}')">Rifiuta</button>
        </span>
      `;
      ul.appendChild(li);
    });
  }
  
  
  // Aggiorna il badge rosso sull'icona amici
  function updateFriendsBadge() {
    const badge = document.getElementById('friendsBadge');
    if (friendsBadgeCount > 0) {
      badge.innerText = friendsBadgeCount;
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  }
  
  
  // Quando premi "Sfida un amico", apri la modale amici
  document.getElementById('challengeFriendBtn').onclick = function() {
    showFriendsModal(false);
  };
  
  
  // Funzione per sfidare un amico dalla lista amici
  window.challengeThisFriend = function(friendUsername) {
    window.socket.emit('challengeFriend', { to: friendUsername, from: localStorage.getItem('username') });
    alert("Invito inviato a " + friendUsername + "!");
  };
  
  
  // Ricevi invito tramite socket e aggiorna badge/notifiche
  window.socket.on('challengeInvite', function(data) {
    challengeInvites.push(data);
    friendsBadgeCount = challengeInvites.length;
    updateFriendsBadge();
    updateFriendsInvitesList();
  });
  
  
  // Accetta/rifiuta invito
  window.acceptChallenge = function(from) {
    window.socket.emit('acceptChallenge', { from, to: localStorage.getItem('username') });
    challengeInvites = challengeInvites.filter(inv => inv.from !== from);
    updateFriendsInvitesList();
    friendsBadgeCount = challengeInvites.length;
    updateFriendsBadge();
  };
  window.rejectChallenge = function(from) {
    window.socket.emit('rejectChallenge', { from, to: localStorage.getItem('username') });
    challengeInvites = challengeInvites.filter(inv => inv.from !== from);
    updateFriendsInvitesList();
    friendsBadgeCount = challengeInvites.length;
    updateFriendsBadge();
  };
  
  
  // Quando la sfida viene accettata, entra in una lobby privata
  window.socket.on('challengeAccepted', function({ lobbyId: newLobbyId }) {
    showSection('mainMenu');
    // Mostra solo la sezione lobby privata, nascondi tutto il resto
    document.getElementById('lobbySection').style.display = 'block';
    document.getElementById('startGameSection').style.display = 'none';
    document.getElementById('playersList').style.display = 'none';
    document.getElementById('lobbyCodeDisplay').style.display = 'none';
    document.getElementById('createLobby').style.display = 'none';
    document.getElementById('joinLobby').style.display = 'none';
    document.getElementById('tournamentBtn').style.display = 'none';
    document.getElementById('challengeFriendBtn').style.display = 'none';
    document.getElementById('lobbyIdInput').style.display = 'none';
    document.getElementById('joinLobbyButton').style.display = 'none';
    // Salva lobbyId e reset stato host/gameStarted
    window.lobbyId = newLobbyId;
    lobbyId = newLobbyId; // <-- AGGIUNGI QUESTO per coerenza con il resto del codice
    // Determina se sei host (chi ha invitato) o guest
    isHost = (window.lastLobbyPlayers && window.lastLobbyPlayers[0] && window.lastLobbyPlayers[0].id === window.socket.id);
    window.isHost = isHost;
    gameStarted = false;
    window.gameStarted = false;
    // Mostra il pulsante "Inizia Gioco" solo all'host
    if (isHost) {
      document.getElementById('startGameSection').style.display = 'block';
    } else {
      document.getElementById('startGameSection').style.display = 'none';
    }
    alert('Sfida accettata! Attendi che la partita inizi.');
  });
  
  
  // Quando ricevi la lista giocatori aggiornata in una lobby (anche challenge)
  window.socket.on('lobbyPlayers', (players) => {
    window.lastLobbyPlayers = players;
    const ul = document.getElementById('playersUl');
    ul.innerHTML = '';
    players.forEach(player => {
      const li = document.createElement('li');
      li.id = `player-${player.id}`;
      // Mostra avatar cartoon accanto al nome
      const avatarUrl = getAvatarForUser(player);
      li.innerHTML = `<img src="${avatarUrl}" alt="avatar" style="width:32px;height:32px;border-radius:50%;vertical-align:middle;margin-right:8px;border:2px solid #ccc;background:#fff;"> ${player.name} (${player.language})`;
      ul.appendChild(li);
    });
    // Mostra la lista solo se la partita non è iniziata
    if (!gameStarted) {
      document.getElementById('playersList').style.display = 'block';
    }
    // Se la lobby è una challenge (2 giocatori, nessun codice), mostra il pulsante "Inizia Gioco" solo all'host
    if (players.length === 2 && window.lobbyId && window.lastLobbyPlayers) {
      // L'host è chi ha id === socket.id (cioè chi ha invitato)
      isHost = (players[0].id === socket.id);
      window.isHost = isHost;
      if (isHost && !gameStarted) {
        document.getElementById('startGameSection').style.display = 'block';
      } else {
        document.getElementById('startGameSection').style.display = 'none';
      }
      // Nascondi input e bottone per codice lobby anche qui (se si rientra)
      document.getElementById('lobbyIdInput').style.display = 'none';
      document.getElementById('joinLobbyButton').style.display = 'none';
    }
  });
  
  
  // Lista amici globale
  let friends = [];
  let challengeInvites = [];
  let friendsBadgeCount = 0;
  
  
  // Ricevi lista amici aggiornata
  socket.on('friendsList', function(list) {
    friends = list;
    // Aggiorna la UI se la modale è aperta
    if (document.getElementById('friendsModal').style.display === 'block') {
      showFriendsModal();
    }
  });
  
  
  // Gestione aggiunta amico
  document.getElementById('addFriendBtn').onclick = function() {
    const friendName = document.getElementById('addFriendInput').value.trim();
    if (!friendName) {
      document.getElementById('addFriendError').innerText = "Inserisci un nome utente!";
      document.getElementById('addFriendError').style.display = 'block';
      return;
    }
    socket.emit('addFriend', { username: localStorage.getItem('username'), friend: friendName }, (res) => {
      if (res && res.error) {
        document.getElementById('addFriendError').innerText = res.error;
        document.getElementById('addFriendError').style.display = 'block';
      } else {
        document.getElementById('addFriendError').innerText = '';
        document.getElementById('addFriendError').style.display = 'none';
        document.getElementById('addFriendInput').value = '';
      }
    });
  };




  function updateAuthUI() {
    const token = localStorage.getItem('token');
    const guestMode = isGuestMode();
    const setupSection = document.getElementById('setupSection');
    const authSectionEl = document.getElementById('authSection'); // Renamed to avoid conflict
    const guestButtonSection = document.getElementById('guestSection');
    const forgotPasswordSec = document.getElementById('forgotPasswordSection');
    const mainMenu = document.getElementById('mainMenu');

    if (guestMode) {
      if (authSectionEl) authSectionEl.style.display = 'none';
      if (guestButtonSection) guestButtonSection.style.display = 'none';
      if (forgotPasswordSec) forgotPasswordSec.style.display = 'none';
      showSetupSection(); 
    } else if (token) {
      if (authSectionEl) authSectionEl.style.display = 'none';
      if (guestButtonSection) guestButtonSection.style.display = 'none';
      if (forgotPasswordSec) forgotPasswordSec.style.display = 'none';
      showSetupSection();
    } else {
      if (authSectionEl) authSectionEl.style.display = 'block';
      if (guestButtonSection) guestButtonSection.style.display = 'block';
      if (setupSection) setupSection.style.display = 'none';
      if (mainMenu) mainMenu.style.display = 'none';
      if (forgotPasswordSec && forgotPasswordSec.style.display !== 'block') {
          forgotPasswordSec.style.display = 'none';
      }
    }
    updateTopBarVisibility(); 
    updateThemeToggleVisibility(); 
  }
  window.addEventListener('DOMContentLoaded', () => {
    updateAuthUI();
  });




  // Chiudi modali cliccando fuori dal contenuto
['profileModal', 'leaderboardModal', 'friendsModal', 'missionsModal', 'shopModal', 'challengeModal', 'challengeInvitesModal'].forEach(modalId => {
  const modal = document.getElementById(modalId);
  if (!modal) return;
  modal.addEventListener('mousedown', function(e) {
    // Chiudi solo se il click è sullo sfondo della modale (cioè direttamente sul div modale)
    if (e.target === modal) {
      modal.style.display = 'none';
      if (modalId === 'friendsModal') {
        friendsBadgeCount = 0;
        updateFriendsBadge();
      }
    }
  });
});




// Utility: chiudi tutte le modali
function closeAllModals() {
  [
    'profileModal',
    'leaderboardModal',
    'friendsModal',
    'missionsModal',
    'shopModal',
    'challengeModal',
    'challengeInvitesModal'
  ].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
}




// Utility: focus sul primo input visibile dentro una modale
function focusFirstInput(modal) {
  if (!modal) return;
  const input = modal.querySelector('input:not([type=hidden]), select, textarea');
  if (input && input.offsetParent !== null) {
    input.focus();
  }
}




// --- PERSONALIZZAZIONE PROFILO: avatar base ---
let selectedAvatar = localStorage.getItem('avatar') || 'avatar1.png';
// document.getElementById('profileAvatar') && (document.getElementById('profileAvatar').src = 'avatars/' + selectedAvatar); // This will be set by updateProfileButtonAvatar or profileData
window.setAvatar = function(avatar) {
  if (isGuestMode()) return; // Guests cannot set avatar
  selectedAvatar = avatar;
  localStorage.setItem('avatar', avatar);
  if (document.getElementById('profileAvatar')) document.getElementById('profileAvatar').src = 'avatars/' + avatar;
  updateProfileButtonAvatar();
  // TODO: Emit to server if user is logged in to save preference
  if (!isGuestMode() && localStorage.getItem('token')) {
    socket.emit('saveAvatar', { avatar });
  }
};




// Aggiorna l'avatar anche sul profile button
function updateProfileButtonAvatar() {
  const btn = document.getElementById('profileButton');
  if (!btn) return;

  const oldImg = btn.querySelector('img.profile-avatar-btn');
  if (oldImg) oldImg.remove();

  let avatarFilename;
  if (isGuestMode()) {
    avatarFilename = 'avatar1.png'; // Default guest avatar
  } else {
    avatarFilename = localStorage.getItem('avatar') || 'avatar1.png';
  }
  
  const img = document.createElement('img');
  img.src = 'avatars/' + avatarFilename;
  img.alt = 'Avatar';
  img.className = 'profile-avatar-btn';
  img.style.width = '32px';
  img.style.height = '32px';
  img.style.borderRadius = '50%';
  img.style.border = '1.5px solid #bbb';
  img.style.verticalAlign = 'middle';
  img.style.background = 'transparent';
  img.style.margin = '0 0 0 0'; // elimina spazio a destra
  img.style.padding = '0';
  img.style.boxShadow = 'none';
  img.style.objectFit = 'cover';
  img.style.display = 'inline-block';
  img.style.position = 'relative';
  img.style.top = '-2px'; // più in alto
  // Nascondi l'icona utente (se presente)
  const icon = btn.querySelector('i.fas.fa-user');
  if (icon) icon.style.display = 'none';
  btn.appendChild(img);
}




// Aggiorna avatar profile button all'avvio
window.addEventListener('DOMContentLoaded', () => {
  updateProfileButtonAvatar();
});




// --- SISTEMA DI CHAT IN LOBBY E IN PARTITA ---
// Lobby chat (pre-partita)
const chatInput = document.getElementById('lobbyChatInput');
const chatSend = document.getElementById('lobbyChatSend');
const chatBox = document.getElementById('lobbyChatBox');
// Chat compatta in partita
const gameChatContainer = document.getElementById('gameChatContainer');
const gameChatInput = document.getElementById('gameChatInput');
const gameChatSend = document.getElementById('gameChatSend');
const gameChatBox = document.getElementById('gameChatBox');




// Utility per mostrare la chat compatta in partita sempre (anche all'host)
function updateGameChatVisibility() {
  const gameVisible = document.getElementById('gameSection').style.display === 'block';
  // Nascondi la chat se single player
  if (gameVisible && gameChatContainer && !singlePlayerMode) {
    gameChatContainer.style.display = 'flex';
  } else if (gameChatContainer) {
    gameChatContainer.style.display = 'none';
  }
}
window.addEventListener('DOMContentLoaded', updateGameChatVisibility);




const origShowSection = showSection;
showSection = function(sectionId) {
  origShowSection(sectionId);
  updateGameChatVisibility();
  updateLobbyChatVisibility();
};




// Funzione per aggiungere un messaggio in una chat box
function appendChatMsg(box, from, msg, isSelf) {
  if (!box) return;
  const div = document.createElement('div');
  div.textContent = (isSelf ? "Tu" : from) + ': ' + msg;
  div.style.fontWeight = isSelf ? 'bold' : 'normal';
  div.style.color = isSelf ? '#1976d2' : '';
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}




// --- GESTIONE MESSAGGI CHAT (UN SOLO HANDLER SOCKET) ---
// Rimuovi ogni handler precedente per evitare duplicati
socket.off('lobbyChat');




// Ricezione messaggi chat (sia lobby che partita)
socket.on('lobbyChat', ({ username: from, msg }) => {
  // Usa sempre il valore aggiornato di username dal localStorage
  const myUsername = localStorage.getItem('username') || username;
  // Mostra sempre il messaggio, sia che venga da te che dagli altri
  // (il controllo per evitare doppioni va fatto SOLO sul proprio client)
  // Se il messaggio è stato appena inviato localmente, NON aggiungerlo di nuovo SOLO su questo client
  if (
    typeof window._lastSentChatMsg === 'object' &&
    window._lastSentChatMsg &&
    window._lastSentChatMsg.msg === msg &&
    window._lastSentChatMsg.username === from &&
    from === myUsername // solo se il messaggio è il TUO
  ) {
    window._lastSentChatMsg = null;
    return;
  }
  appendChatMsg(chatBox, from, msg, from === myUsername);
  appendChatMsg(gameChatBox, from, msg, from === myUsername);
});




// Invio messaggi dalla lobby
if (chatInput && chatSend) {
  chatSend.onclick = function() {
    const msg = chatInput.value.trim();
    if (msg) {
      // Mostra subito il messaggio nella chat LOCALE per feedback immediato
      appendChatMsg(chatBox, username, msg, true);
      // Salva l'ultimo messaggio inviato localmente
      window._lastSentChatMsg = { username, msg };
      socket.emit('lobbyChat', { lobbyId, username, msg });
      chatInput.value = '';
    }
  };
  chatInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') chatSend.click();
  });
}




// Invio messaggi dalla chat compatta in partita
if (gameChatInput && gameChatSend) {
  gameChatSend.onclick = function() {
    const msg = gameChatInput.value.trim();
    if (msg) {
      appendChatMsg(gameChatBox, username, msg, true);
      window._lastSentChatMsg = { username, msg };
      socket.emit('lobbyChat', { lobbyId, username, msg });
      gameChatInput.value = '';
    }
  };
  gameChatInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') gameChatSend.click();
  });
}




// Quando inizia la partita, svuota la chat compatta ma NON nasconderla mai
socket.on('newQuestion', () => {
  if (gameChatBox) gameChatBox.innerHTML = '';
  updateGameChatVisibility();
  updateLobbyChatVisibility(); // <--- aggiungi questa riga
});




// --- INTEGRAZIONE SOCIAL: condividi risultato ---
window.shareResult = function(score) {
  const shareText = `Ho appena fatto ${score} punti su Quiz Game! Prova anche tu!`;
  if (navigator.share) {
    navigator.share({ text: shareText });
  } else {
    prompt('Copia e condividi il tuo risultato:', shareText);
  }
};




// --- TUTORIAL INTERATTIVO MIGLIORATO ---
window.showTutorial = function() {
  const steps = [
    {
      title: "Benvenuto su Quiz Game!",
      text: "In questo tutorial ti mostreremo come iniziare a giocare, creare una lobby e usare i power-up.",
      highlight: null
    },
    {
      title: "Come creare una lobby",
      text: "Dopo aver effettuato l'accesso o scelto di giocare come ospite, clicca su <b>'Crea una Lobby'</b> per iniziare una nuova partita con i tuoi amici o altri giocatori.",
      highlight: "#createLobby"
    },
    {
      title: "Come unirsi a una lobby",
      text: "Se vuoi unirti a una partita già esistente, clicca su <b>'Unisciti a una Lobby'</b> e inserisci il codice fornito dal tuo amico.",
      highlight: "#joinLobby"
    },
    {
      title: "Come giocare",
      text: "Quando la partita inizia, leggi la domanda e scegli la risposta corretta tra le opzioni. Più risposte corrette dai, più punti ottieni!",
      highlight: "#gameSection"
    },
    {
      title: "Come usare i power-up",
      text: "Durante la partita puoi usare i power-up:<br><b>🌓 50:50</b> elimina due risposte sbagliate.<br><b>⏭️ Salta</b> passa alla prossima domanda.<br><b>⏰ +10s</b> aggiunge tempo.<br>Clicca sui pulsanti corrispondenti per attivarli.",
      highlight: "#powerUps"
    },
    {
      title: "Buon divertimento!",
      text: "Ora sei pronto per giocare e sfidare i tuoi amici. Buona fortuna!",
      highlight: null
    }
  ];




  let currentStep = 0;
  let overlay = document.getElementById('tutorialOverlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'tutorialOverlay';
    overlay.style.position = 'fixed';
    overlay.style.top = 0;
    overlay.style.left = 0;
    overlay.style.right = 0;
    overlay.style.bottom = 0;
    overlay.style.background = 'rgba(0,0,0,0.65)';
    overlay.style.zIndex = 99999;
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.innerHTML = `
      <div id="tutorialBox" style="background:#fff;color:#222;max-width:350px;padding:28px 22px 18px 22px;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.18);position:relative;text-align:left;">
        <h2 id="tutorialTitle" style="margin-top:0"></h2>
        <div id="tutorialText" style="margin-bottom:18px;font-size:1.08em;"></div>
        <div style="text-align:right;">
          <button id="tutorialPrev" style="display:none;margin-right:8px;">Indietro</button>
          <button id="tutorialNext">Avanti</button>
          <button id="tutorialClose" style="margin-left:8px;">Chiudi</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
  }




  function highlightElement(selector) {
    // Rimuovi highlight precedente
    document.querySelectorAll('.tutorial-highlight').forEach(el => {
      el.classList.remove('tutorial-highlight');
      el.style.boxShadow = '';
      el.style.position = '';
      el.style.zIndex = '';
    });
    if (!selector) return;
    const el = document.querySelector(selector);
    if (el) {
      el.classList.add('tutorial-highlight');
      el.style.boxShadow = '0 0 0 4px gold, 0 0 16px 4px #ffd70099';
      el.style.position = 'relative';
      el.style.zIndex = 10001;
      // Scrolla se fuori viewport
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }




  function showStep(idx) {
    const step = steps[idx];
    document.getElementById('tutorialTitle').innerText = step.title;
    document.getElementById('tutorialText').innerHTML = step.text;
    document.getElementById('tutorialPrev').style.display = idx > 0 ? 'inline-block' : 'none';
    document.getElementById('tutorialNext').style.display = idx < steps.length - 1 ? 'inline-block' : 'none';
    highlightElement(step.highlight);
  }




  document.getElementById('tutorialPrev').onclick = function() {
    if (currentStep > 0) {
      currentStep--;
      showStep(currentStep);
    }
  };
  document.getElementById('tutorialNext').onclick = function() {
    if (currentStep < steps.length - 1) {
      currentStep++;
      showStep(currentStep);
    }
  };
  document.getElementById('tutorialClose').onclick = function() {
    overlay.style.display = 'none';
    highlightElement(null);
  };




  overlay.style.display = 'flex';
  currentStep = 0;
  showStep(currentStep);
}




// --- SISTEMA DI MISSIONI E OBIETTIVI ---




// Tutte le missioni possibili (pool)
const ALL_MISSIONS = [
  {
    id: 'daily-history-5',
    type: 'daily',
    description: 'Rispondi correttamente a 5 domande di storia',
    category: 'History',
    required: 5,
    reward: { coins: 50 },
  },
  {
    id: 'daily-sport-5',
    type: 'daily',
    description: 'Rispondi correttamente a 5 domande di sport',
    category: 'Sport',
    required: 5,
    reward: { coins: 50 },
  },
  {
    id: 'daily-geography-5',
    type: 'daily',
    description: 'Rispondi correttamente a 5 domande di geografia',
    category: 'Geography',
    required: 5,
    reward: { coins: 50 },
  },
  {
    id: 'daily-correct-10',
    type: 'daily',
    description: 'Dai 10 risposte corrette in qualsiasi categoria',
    category: null,
    required: 10,
    reward: { powerup: '5050' },
  },
  {
    id: 'daily-fast-3',
    type: 'daily',
    description: 'Rispondi correttamente a 3 domande in meno di 5 secondi',
    category: null,
    required: 3,
    reward: { coins: 30 },
  },
  {
    id: 'daily-wrong-3',
    type: 'daily',
    description: 'Dai 3 risposte sbagliate (non farlo apposta!)',
    category: null,
    required: 3,
    reward: { coins: 10 },
  },
  {
    id: 'weekly-win-3',
    type: 'weekly',
    description: 'Vinci 3 partite',
    category: null,
    required: 3,
    reward: { avatar: 'avatar2.png' },
  }
];




// Quante missioni giornaliere mostrare
const DAILY_MISSIONS_COUNT = 2;




// Genera missioni giornaliere casuali e salva ciclo
function generateDailyMissions() {
  // Prendi solo missioni di tipo daily
  const dailyPool = ALL_MISSIONS.filter(m => m.type === 'daily');
  // Mischia e prendi N diverse
  const shuffled = dailyPool.sort(() => Math.random() - 0.5);
  const selected = shuffled.slice(0, DAILY_MISSIONS_COUNT);
  // Aggiungi sempre la weekly (puoi cambiare logica se vuoi)
  const weekly = ALL_MISSIONS.find(m => m.type === 'weekly');
  const missions = [...selected, weekly];
  // Salva ciclo e timestamp
  const cycleStart = Date.now();
  localStorage.setItem('missionsCycleStart', cycleStart);
  localStorage.setItem('missionsCycleMissions', JSON.stringify(missions.map(m => m.id)));
  // Stato iniziale
  const obj = {};
  missions.forEach(m => obj[m.id] = { progress: 0, claimed: false, lastReset: cycleStart });
  localStorage.setItem('userMissions', JSON.stringify(obj));
  return missions;
}




// Carica missioni attive per il ciclo corrente
function getCurrentMissions() {
  let ids = [];
  try {
    ids = JSON.parse(localStorage.getItem('missionsCycleMissions') || '[]');
  } catch { ids = []; }
  if (!ids.length) return generateDailyMissions();
  return ids.map(id => ALL_MISSIONS.find(m => m.id === id)).filter(Boolean);
}




// Controlla se serve rigenerare missioni (ogni 24h dal ciclo)
function maybeResetMissions() {
  const cycleStart = parseInt(localStorage.getItem('missionsCycleStart') || '0', 10);
  const now = Date.now();
  if (!cycleStart || now - cycleStart >= 24 * 60 * 60 * 1000) {
    generateDailyMissions();
    userMissions = loadUserMissions();
    MISSIONS.length = 0;
    getCurrentMissions().forEach(m => MISSIONS.push(m));
    return true;
  }
  return false;
}




// Stato missioni utente (caricato/salvato su localStorage)
function loadUserMissions() {
  let state = localStorage.getItem('userMissions');
  if (state) return JSON.parse(state);
  // Se non esiste, genera nuove missioni
  generateDailyMissions();
  return JSON.parse(localStorage.getItem('userMissions'));
}
function saveUserMissions(state) {
  localStorage.setItem('userMissions', JSON.stringify(state));
}




// Missioni attive per il ciclo corrente
const MISSIONS = [];
getCurrentMissions().forEach(m => MISSIONS.push(m));
let userMissions = loadUserMissions();




// Mostra la modale missioni
function showMissionsModal() {
  if (isGuestMode()) return; // Guests cannot access missions
  maybeResetMissions();
  // Aggiorna MISSIONS array se serve
  MISSIONS.length = 0;
  getCurrentMissions().forEach(m => MISSIONS.push(m));
  userMissions = loadUserMissions();
  const modal = document.getElementById('missionsModal');
  if (!modal) return;
  modal.style.display = 'block';
  // Popola lista missioni
  const ul = modal.querySelector('#missionsList');
  ul.innerHTML = '';
  MISSIONS.forEach(m => {
    const ms = userMissions[m.id] || { progress: 0, claimed: false };
    const li = document.createElement('li');
    li.style.marginBottom = '12px';
    const done = ms.progress >= m.required;
    li.innerHTML = `
      <span>${m.description}</span><br>
      <progress value="${Math.min(ms.progress, m.required)}" max="${m.required}" style="width:80%"></progress>
      <span> ${ms.progress}/${m.required}</span>
      ${done && !ms.claimed ? `<button data-claim="${m.id}" style="margin-left:8px">Riscatta</button>` : ''}
      ${ms.claimed ? `<span style="color:green;margin-left:8px">Riscattata!</span>` : ''}
      <br><small>Ricompensa: ${m.reward.coins ? m.reward.coins + ' monete' : m.reward.avatar ? 'Avatar' : m.reward.powerup ? 'Power-up ' + m.reward.powerup : ''}</small>
    `;
    ul.appendChild(li);
  });
  // Handler riscatto
  ul.querySelectorAll('button[data-claim]').forEach(btn => {
    btn.onclick = function() {
      const id = this.getAttribute('data-claim');
      claimMissionReward(id);
      showMissionsModal(); // refresh
    };
  });
}




// Chiudi modale missioni
document.getElementById('closeMissionsModal').onclick = () => {
  document.getElementById('missionsModal').style.display = 'none';
};




// Chiudi cliccando fuori dalla modale
document.getElementById('missionsModal').addEventListener('mousedown', function(e) {
  if (e.target === this) this.style.display = 'none';
});




// Riscatta ricompensa missione
function claimMissionReward(missionId) {
  if (isGuestMode()) return; // Guests cannot claim rewards
  const m = MISSIONS.find(x => x.id === missionId);
  if (!m) return;
  const ms = userMissions[missionId];
  if (!ms || ms.claimed || ms.progress < m.required) return;
  ms.claimed = true;
  // Ricompense demo: aggiorna localStorage, mostra alert
  if (m.reward.coins) {
    let coins = parseInt(localStorage.getItem('profileCoins') || '0', 10);
    coins += m.reward.coins;
    localStorage.setItem('profileCoins', coins);
    alert(`Hai ricevuto ${m.reward.coins} monete!`);
  }
  if (m.reward.avatar) {
    localStorage.setItem('avatar', m.reward.avatar);
    alert('Nuovo avatar sbloccato!');
    updateProfileButtonAvatar();
  }
  if (m.reward.powerup) {
    let powerups = JSON.parse(localStorage.getItem('powerups') || '{}');
    powerups[m.reward.powerup] = (powerups[m.reward.powerup] || 0) + 1;
    localStorage.setItem('powerups', JSON.stringify(powerups));
    alert('Hai ricevuto un power-up!');
  }
  saveUserMissions(userMissions);
}




// Aggiorna progresso missioni quando rispondi a una domanda
function updateMissionsOnAnswer({ correct, category }) {
  if (isGuestMode()) return; // Guests do not progress missions
  let changed = false;
  MISSIONS.forEach(m => {
    const ms = userMissions[m.id];
    if (!ms || ms.claimed) return;
    // Logica per ogni missione
    if (m.id === 'daily-history-5' && correct && category === 'History') {
      ms.progress++;
      changed = true;
    }
    if (m.id === 'daily-sport-5' && correct && category === 'Sport') {
      ms.progress++;
      changed = true;
    }
    if (m.id === 'daily-geography-5' && correct && category === 'Geography') {
      ms.progress++;
      changed = true;
    }
    if (m.id === 'daily-correct-10' && correct) {
      ms.progress++;
      changed = true;
    }
    if (m.id === 'daily-fast-3' && correct && window.lastAnswerTime && window.lastAnswerTime < 5) {
      ms.progress++;
      changed = true;
    }
    if (m.id === 'daily-wrong-3' && !correct) {
      ms.progress++;
      changed = true;
    }
  });
  if (changed) saveUserMissions(userMissions);
}




// Aggiorna progresso missioni quando vinci una partita
function updateMissionsOnWin() {
  if (isGuestMode()) return; // Guests do not progress missions
  let changed = false;
  MISSIONS.forEach(m => {
    const ms = userMissions[m.id];
    if (!ms || ms.claimed) return;
    if (m.id === 'weekly-win-3') {
      ms.progress++;
      changed = true;
    }
  });
  if (changed) saveUserMissions(userMissions);
}




// --- AGGIUNGI BOTTONE MISSIONI ALLA UI (vicino al profilo) ---
window.addEventListener('DOMContentLoaded', () => {
  let btn = document.getElementById('missionsButton');
  if (!btn) {
    btn = document.createElement('button');
    btn.id = 'missionsButton';
    btn.innerText = '🎯 Missioni';
    btn.style.marginLeft = '8px';
    const profileBtn = document.getElementById('profileButton');
    if (profileBtn && profileBtn.parentNode) {
      profileBtn.parentNode.insertBefore(btn, profileBtn.nextSibling);
    } else {
      document.body.appendChild(btn);
    }
    btn.onclick = showMissionsModal;
  }




  // SHOP BUTTON: collega sempre il click
  let shopBtn = document.getElementById('shopButton');
  if (shopBtn) {
    shopBtn.onclick = function() { // Wrap to add guest check
        if (isGuestMode()) return;
        window.showShop();
    }
  } else {
    // Se non esiste (es. HTML non aggiornato), crea il bottone e inseriscilo
    shopBtn = document.createElement('button');
    shopBtn.id = 'shopButton';
    shopBtn.innerText = '🛒 Shop';
    shopBtn.style.marginLeft = '8px';
    if (profileBtn && profileBtn.parentNode) {
      profileBtn.parentNode.insertBefore(shopBtn, profileBtn.nextSibling);
    } else {
      document.body.appendChild(shopBtn);
    }
    shopBtn.onclick = function() { // Wrap to add guest check
        if (isGuestMode()) return;
        window.showShop();
    };
  }
});




// --- SHOP CONFIGURAZIONE (dinamico giornaliero) ---
// RIMUOVI QUESTA COSTANTE, LA CARICHEREMO DAL BACKEND
/*
const ALL_SHOP_ITEMS = [
  // Avatar rari/esclusivi
  { id: 'avatar9', type: 'avatar', name: 'Avatar Drago', img: 'avatars/avatar9.png', price: 200, currency: 'coins', rarity: 'rare' },
  { id: 'avatar10', type: 'avatar', name: 'Avatar Ninja', img: 'avatars/avatar10.png', price: 300, currency: 'coins', rarity: 'epic' },
  { id: 'avatar11', type: 'avatar', name: 'Avatar Fenice', img: 'avatars/avatar11.png', price: 500, currency: 'gems', rarity: 'legendary' },
  { id: 'avatar12', type: 'avatar', name: 'Avatar Robot', img: 'avatars/avatar12.png', price: 150, currency: 'coins', rarity: 'rare' },
  { id: 'avatar13', type: 'avatar', name: 'Avatar Pirata', img: 'avatars/avatar13.png', price: 180, currency: 'coins', rarity: 'rare' },
  { id: 'avatar14', type: 'avatar', name: 'Avatar Astronauta', img: 'avatars/avatar14.png', price: 220, currency: 'coins', rarity: 'epic' },
  { id: 'avatar15', type: 'avatar', name: 'Avatar Gatto', img: 'avatars/avatar15.png', price: 120, currency: 'coins', rarity: 'common' },
  { id: 'avatar16', type: 'avatar', name: 'Avatar Cagnolino', img: 'avatars/avatar16.png', price: 120, currency: 'coins', rarity: 'common' },
  { id: 'avatar17', type: 'avatar', name: 'Avatar Unicorno', img: 'avatars/avatar17.png', price: 250, currency: 'coins', rarity: 'epic' },
  { id: 'avatar18', type: 'avatar', name: 'Avatar T-rex', img: 'avatars/avatar18.png', price: 400, currency: 'gems', rarity: 'legendary' },
  { id: 'avatar19', type: 'avatar', name: 'Avatar Fantasma', img: 'avatars/avatar19.png', price: 350, currency: 'gems', rarity: 'legendary' },
  { id: 'avatar20', type: 'avatar', name: 'Avatar Alieno', img: 'avatars/avatar20.png', price: 400, currency: 'gems', rarity: 'legendary' },
  { id: 'avatar21', type: 'avatar', name: 'Avatar Angioletto', img: 'avatars/avatar21.png', price: 450, currency: 'gems', rarity: 'legendary' },
  { id: 'avatar22', type: 'avatar', name: 'Avatar Diavoletto', img: 'avatars/avatar22.png', price: 400, currency: 'gems', rarity: 'legendary' },
  { id: 'avatar23', type: 'avatar', name: 'Avatar Cavaliere', img: 'avatars/avatar23.png', price: 200, currency: 'coins', rarity: 'rare' },
  { id: 'avatar24', type: 'avatar', name: 'Avatar Principessa', img: 'avatars/avatar24.png', price: 220, currency: 'coins', rarity: 'epic' },
  { id: 'avatar25', type: 'avatar', name: 'Avatar Samurai', img: 'avatars/avatar25.png', price: 250, currency: 'coins', rarity: 'epic' },
  { id: 'avatar26', type: 'avatar', name: 'Avatar Astronauta Rosa', img: 'avatars/avatar26.png', price: 230, currency: 'coins', rarity: 'epic' },
  { id: 'avatar27', type: 'avatar', name: 'Avatar Panda', img: 'avatars/avatar27.png', price: 180, currency: 'coins', rarity: 'common' },
  { id: 'avatar28', type: 'avatar', name: 'Avatar Volpe', img: 'avatars/avatar28.png', price: 180, currency: 'coins', rarity: 'common' },
  { id: 'avatar29', type: 'avatar', name: 'Avatar Cavallo', img: 'avatars/avatar29.png', price: 200, currency: 'coins', rarity: 'rare' },
  { id: 'avatar30', type: 'avatar', name: 'Avatar Polpo', img: 'avatars/avatar30.png', price: 210, currency: 'coins', rarity: 'rare' },
  { id: 'avatar31', type: 'avatar', name: 'Avatar Strega', img: 'avatars/avatar31.png', price: 300, currency: 'gems', rarity: 'legendary' },
  { id: 'avatar32', type: 'avatar', name: 'Avatar Supereroe', img: 'avatars/avatar32.png', price: 350, currency: 'gems', rarity: 'legendary' },
  { id: 'avatar33', type: 'avatar', name: 'Avatar Leone', img: 'avatars/avatar33.png', price: 220, currency: 'coins', rarity: 'epic' },
  { id: 'avatar34', type: 'avatar', name: 'Avatar Pinguino', img: 'avatars/avatar34.png', price: 140, currency: 'coins', rarity: 'common' },
  { id: 'avatar35', type: 'avatar', name: 'Avatar Koala', img: 'avatars/avatar35.png', price: 160, currency: 'coins', rarity: 'common' },
  { id: 'avatar36', type: 'avatar', name: 'Avatar Squalo', img: 'avatars/avatar36.png', price: 200, currency: 'coins', rarity: 'rare' },
  { id: 'avatar37', type: 'avatar', name: 'Avatar Gufo', img: 'avatars/avatar37.png', price: 180, currency: 'coins', rarity: 'rare' },
  { id: 'avatar38', type: 'avatar', name: 'Avatar Lupo', img: 'avatars/avatar38.png', price: 210, currency: 'coins', rarity: 'epic' },
  { id: 'avatar39', type: 'avatar', name: 'Avatar Elefante', img: 'avatars/avatar39.png', price: 170, currency: 'coins', rarity: 'common' },
  { id: 'avatar40', type: 'avatar', name: 'Avatar Coccinella', img: 'avatars/avatar40.png', price: 120, currency: 'coins', rarity: 'common' },
  { id: 'avatar41', type: 'avatar', name: 'Avatar Pappagallo', img: 'avatars/avatar41.png', price: 180, currency: 'coins', rarity: 'rare' },
  { id: 'avatar42', type: 'avatar', name: 'Avatar Delfino', img: 'avatars/avatar42.png', price: 200, currency: 'coins', rarity: 'rare' },
  { id: 'avatar43', type: 'avatar', name: 'Avatar Leone Marino', img: 'avatars/avatar43.png', price: 150, currency: 'coins', rarity: 'common' },
  { id: 'avatar44', type: 'avatar', name: 'Avatar Fenicottero', img: 'avatars/avatar44.png', price: 170, currency: 'coins', rarity: 'rare' },
  { id: 'avatar45', type: 'avatar', name: 'Avatar Scoiattolo', img: 'avatars/avatar45.png', price: 120, currency: 'coins', rarity: 'common' },
  { id: 'avatar46', type: 'avatar', name: 'Avatar Cervo', img: 'avatars/avatar46.png', price: 180, currency: 'coins', rarity: 'rare' },
  { id: 'avatar47', type: 'avatar', name: 'Avatar Riccio', img: 'avatars/avatar47.png', price: 130, currency: 'coins', rarity: 'common' },
  { id: 'avatar48', type: 'avatar', name: 'Avatar Giraffa', img: 'avatars/avatar48.png', price: 200, currency: 'coins', rarity: 'rare' },
  { id: 'avatar49', type: 'avatar', name: 'Avatar Gorilla', img: 'avatars/avatar49.png', price: 210, currency: 'coins', rarity: 'epic' },
  { id: 'avatar50', type: 'avatar', name: 'Avatar Cammello', img: 'avatars/avatar50.png', price: 170, currency: 'coins', rarity: 'common' },
  { id: 'avatar51', type: 'avatar', name: 'Avatar Zebra', img: 'avatars/avatar51.png', price: 180, currency: 'coins', rarity: 'rare' },
  { id: 'avatar52', type: 'avatar', name: 'Avatar Piuma', img: 'avatars/avatar52.png', price: 120, currency: 'coins', rarity: 'common' },
  { id: 'avatar53', type: 'avatar', name: 'Avatar Orso Polare', img: 'avatars/avatar53.png', price: 200, currency: 'coins', rarity: 'rare' },
  { id: 'avatar54', type: 'avatar', name: 'Avatar Rana', img: 'avatars/avatar54.png', price: 120, currency: 'coins', rarity: 'common' },
  { id: 'avatar55', type: 'avatar', name: 'Avatar Coccodrillo', img: 'avatars/avatar55.png', price: 210, currency: 'coins', rarity: 'epic' },
  { id: 'avatar56', type: 'avatar', name: 'Avatar Fenice Blu', img: 'avatars/avatar56.png', price: 500, currency: 'gems', rarity: 'legendary' },
  { id: 'avatar57', type: 'avatar', name: 'Avatar Drago Verde', img: 'avatars/avatar57.png', price: 500, currency: 'gems', rarity: 'legendary' },
  { id: 'avatar58', type: 'avatar', name: 'Avatar Robot Rosso', img: 'avatars/avatar58.png', price: 250, currency: 'coins', rarity: 'epic' },
  { id: 'avatar59', type: 'avatar', name: 'Avatar Astronauta Giallo', img: 'avatars/avatar59.png', price: 230, currency: 'coins', rarity: 'epic' },
  { id: 'avatar60', type: 'avatar', name: 'Avatar Gatto Nero', img: 'avatars/avatar60.png', price: 150, currency: 'coins', rarity: 'rare' },
  { id: 'avatar61', type: 'avatar', name: 'Avatar Volpe Artica', img: 'avatars/avatar61.png', price: 200, currency: 'coins', rarity: 'rare' },
  { id: 'avatar62', type: 'avatar', name: 'Avatar Panda Rosso', img: 'avatars/avatar62.png', price: 220, currency: 'coins', rarity: 'epic' },
  { id: 'avatar63', type: 'avatar', name: 'Avatar Unicorno Arcobaleno', img: 'avatars/avatar63.png', price: 60, currency: 'gems', rarity: 'legendary' },
  { id: 'avatar64', type: 'avatar', name: 'Avatar Elfa', img: 'avatars/avatar64.png', price: 60, currency: 'gems', rarity: 'legendary' },
// ...existing code...
  // Sfondi
  { id: 'bg1', type: 'background', name: 'Sfondo Galassia', img: 'backgrounds/bg1.jpg', price: 100, currency: 'coins' },
  { id: 'bg2', type: 'background', name: 'Sfondo Foresta', img: 'backgrounds/bg2.jpg', price: 120, currency: 'coins' },
  { id: 'bg3', type: 'background', name: 'Sfondo Spiaggia', img: 'backgrounds/bg3.jpg', price: 120, currency: 'coins' },
  { id: 'bg4', type: 'background', name: 'Sfondo Città Notturna', img: 'backgrounds/bg4.jpg', price: 140, currency: 'coins' },
  { id: 'bg5', type: 'background', name: 'Sfondo Tramonto', img: 'backgrounds/bg5.jpg', price: 130, currency: 'coins' },
  { id: 'bg6', type: 'background', name: 'Sfondo Montagna', img: 'backgrounds/bg6.jpg', price: 130, currency: 'coins' },
  { id: 'bg7', type: 'background', name: 'Sfondo Spazio', img: 'backgrounds/bg7.jpg', price: 150, currency: 'coins' },
  // Valuta virtuale (sempre disponibili)
  { id: 'coins500', type: 'currency', name: '500 Monete', price: 2, currency: 'eur', amount: 500 },
  { id: 'gems10', type: 'currency', name: '10 Gemme', price: 1, currency: 'eur', amount: 10 }
];
*/// Fine blocco ALL_SHOP_ITEMS rimosso

// Tutta la logica dello shop è stata spostata in shop.js
// _allShopItemsCache, SHOP_DAILY_AVATAR_COUNT, SHOP_DAILY_BG_COUNT,
// getDailyShopItems, showShop, renderShopItems, buyShopItem
// sono state rimosse da qui.

// --- Utility per ottenere l'avatar cartoon di un utente (default se non impostato) ---
function getAvatarForUser(user) {
  // If guest mode is globally active and this user is the current guest, use default.
  // However, `user` object might come from server and not reflect current client's guest status directly.
  // The most reliable is if the server marks guest players.
  // For now, if user object itself indicates guest or has no avatar:
  if (user.isGuest || !user.avatar) { // Assuming server might add 'isGuest' to player objects
     // If it's the current player and they are in guest mode on the client
    if (user.username === localStorage.getItem('username') && isGuestMode()) {
        return 'avatars/avatar1.png';
    }
    // If user object from server has an avatar, use it, otherwise default.
    return user.avatar ? 'avatars/' + user.avatar : 'avatars/avatar1.png';
  }
  return 'avatars/' + user.avatar; // Regular user with avatar
}




// --- LOBBY: mostra avatar cartoon accanto al nome ---
socket.on('lobbyPlayers', (players) => {
  window.lastLobbyPlayers = players;
  const ul = document.getElementById('playersUl');
  ul.innerHTML = '';
  players.forEach(player => {
    const li = document.createElement('li');
    li.id = `player-${player.id}`;
    // Mostra avatar cartoon accanto al nome
    const avatarUrl = getAvatarForUser(player);
    li.innerHTML = `<img src="${avatarUrl}" alt="avatar" style="width:32px;height:32px;border-radius:50%;vertical-align:middle;margin-right:8px;border:2px solid #ccc;background:#fff;"> ${player.name} (${player.language})`;
    ul.appendChild(li);
  });
  if (!gameStarted) {
    document.getElementById('playersList').style.display = 'block';
  }
});




// --- SCOREBOARD: mostra avatar cartoon accanto al nome ---
socket.on('scoreboard', (scores) => {
  const lang = document.getElementById('languageSelect').value || 'en';
  const t = translations[lang] || translations['en'];
  const scoreboardScreen = document.getElementById('scoreboardScreen');
  const questionText = document.getElementById('questionText');
  const answersList = document.getElementById('answersList');
  const timerText = document.getElementById('timerText');








  questionText.style.display = 'none';
  answersList.style.display = 'none';
  timerText.style.display = 'none';








  scoreboardScreen.innerHTML = `<h2>${t.scoreboard}</h2>`;








  scores.sort((a, b) => b.score - a.score);








  scores.forEach((score, index) => {
    const playerScore = document.createElement('div');








    let medal = '';
    if (index === 0) {
      medal = '🥇';
      playerScore.className = 'podium-first';
    } else if (index === 1) {
      medal = '🥈';
      playerScore.className = 'podium-second';
    } else if (index === 2) {
      medal = '🥉';
      playerScore.className = 'podium-third';
    } else {
      playerScore.className = 'scoreboard-player';
    }








    const avatarUrl = getAvatarForUser(score);
    playerScore.innerHTML = `${medal} <img src="${avatarUrl}" alt="avatar" style="width:28px;height:28px;border-radius:50%;vertical-align:middle;margin-right:6px;border:2px solid #ccc;background:#fff;"> ${index + 1}. ${score.name} - ${score.score} ${t.score}`;
    scoreboardScreen.appendChild(playerScore);
  });








  scoreboardScreen.classList.remove('fade-out');
  scoreboardScreen.classList.add('fade-in');
  scoreboardScreen.style.display = 'block';








  // Nascondi il pulsante Prosegui durante la classifica in single player
  if (singlePlayerMode) showNextQuestionBtn(false);








  setTimeout(() => {
    scoreboardScreen.classList.remove('fade-in');
    scoreboardScreen.classList.add('fade-out');








    setTimeout(() => {
      scoreboardScreen.style.display = 'none';
      questionText.style.display = 'block';
      answersList.style.display = 'block';
      timerText.style.display = 'block';
      // Ri-mostra il pulsante Prosegui solo se single player e c'è una domanda
      if (singlePlayerMode) showNextQuestionBtn(true);
    }, 1000);
  }, 5000);
  // Aggiorna trofei single player se presenti
  if (singlePlayerMode && scores.length === 1 && typeof scores[0].singlePlayerTrophies === 'number') {
    singlePlayerTrophies = scores[0].singlePlayerTrophies;
    document.getElementById('singlePlayerTrophies').innerText = singlePlayerTrophies;
  }
});




// --- GAME OVER: mostra avatar cartoon accanto al nome ---
socket.on('gameOver', ({ message, finalScores, singlePlayerMode: spm }) => {
  const lang = document.getElementById('languageSelect').value || 'en';
  const t = translations[lang] || translations['en'];
  document.getElementById('gameSection').style.display = 'none';
  document.getElementById('gameOverScreen').style.display = 'block';
  const finalScoresList = document.getElementById('finalScores');
  finalScoresList.innerHTML = '';
  const guestMode = isGuestMode(); // Check guest mode

  finalScores.forEach(player => {
    const avatarUrl = getAvatarForUser(player);
    const li = document.createElement('li');
    li.innerHTML = `<img src="${avatarUrl}" alt="avatar" style="width:28px;height:28px;border-radius:50%;vertical-align:middle;margin-right:6px;border:2px solid #ccc;background:#fff;"> ${t.player} ${player.name} (${player.language}) - ${t.score}: ${player.score}`;
    finalScoresList.appendChild(li);
  });

  if (!guestMode) { // Only for logged-in users
    loadLeaderboard('national');
    loadLeaderboard('global');
    window.socket.emit('getProfile');
    // Aggiorna trofei single player anche qui
    if (spm && finalScores.length === 1 && typeof finalScores[0].singlePlayerTrophies === 'number') {
      singlePlayerTrophies = finalScores[0].singlePlayerTrophies;
      document.getElementById('singlePlayerTrophies').innerText = singlePlayerTrophies;
    }
    const myUsername = localStorage.getItem('username');
    if (finalScores && finalScores.length && finalScores[0].name === myUsername) {
      updateMissionsOnWin();
    }
  }
  // Share button should be visible for guests too
});




window.setBackground = function(path) {
  if (isGuestMode()) {
    console.log('[setBackground] Guest mode: Operation disabled. Guests use light/dark theme toggle.');
    return;
  }
  console.log('[window.setBackground] Called with path:', path);
  const currentBg = localStorage.getItem('background');
  console.log('[window.setBackground] current localStorage background is:', currentBg);

  // Se si clicca sullo stesso sfondo già attivo (e path non è null)
  if (currentBg === path && path && path !== "null" && path !== "undefined") { 
    console.log('[window.setBackground] Deselecting current background:', path);
    localStorage.removeItem('background');
    console.log('[window.setBackground] Removed "background" from localStorage.');
    // Richiama applyBackgroundTheme con null per resettare tutto
    applyBackgroundTheme(null); 
    return;
  }

  if (path && path !== "null" && path !== "undefined") {
    console.log('[window.setBackground] Setting new background:', path);
    localStorage.setItem('background', path);
    console.log('[window.setBackground] SetItem "background" to:', path, 'in localStorage.');
    applyBackgroundTheme(path);
    const themeToggler = document.getElementById('themeToggle');
    if (themeToggler) themeToggler.style.display = 'none';
  } else { // path è nullo, undefined, o stringa "null"/"undefined" -> rimuovi sfondo
    console.log('[window.setBackground] Path is invalid (null, undefined, or string "null"/"undefined"), removing custom background.');
    localStorage.removeItem('background');
    console.log('[window.setBackground] Removed "background" from localStorage (path was invalid).');
    applyBackgroundTheme(null); // Resetta lo sfondo e mostra il themeToggler
  }
};




window.addEventListener('DOMContentLoaded', () => {
  console.log('[DOMContentLoaded] Starting. localStorage snapshot:', JSON.stringify(localStorage));
  updateProfileButtonAvatar();

  const savedBackground = localStorage.getItem('background');
  const currentGuestMode = isGuestMode(); // Check for guest mode here
  console.log('[DOMContentLoaded] localStorage background:', savedBackground, 'Guest Mode:', currentGuestMode);

  if (currentGuestMode) {
    console.log('[DOMContentLoaded] Guest mode detected. Applying default theme via applyBackgroundTheme(null).');
    applyBackgroundTheme(null); // This will correctly set up light/dark for guest
  } else if (savedBackground && savedBackground !== "null" && savedBackground !== "undefined") {
    console.log('[DOMContentLoaded] Valid savedBackground found. Calling applyBackgroundTheme with:', savedBackground);
    applyBackgroundTheme(savedBackground);
    // Forza di nuovo per sicurezza dopo applyBackgroundTheme e attendi un frame
    requestAnimationFrame(() => {
        document.body.setAttribute('data-theme', 'custom-bg');
        console.log('[DOMContentLoaded] requestAnimationFrame: FORCED data-theme to "custom-bg". Current body data-theme:', document.body.getAttribute('data-theme'));
        // Logga lo stato degli stili del container
        const container = document.querySelector('.container');
        if (container) {
            const styles = window.getComputedStyle(container);
            console.log('[DOMContentLoaded] requestAnimationFrame: .container computed background:', styles.backgroundColor);
            console.log('[DOMContentLoaded] requestAnimationFrame: .container computed color:', styles.color);
        }
    });
  } else {
    console.log('[DOMContentLoaded] No valid savedBackground. Applying default theme via applyBackgroundTheme(null).');
    applyBackgroundTheme(null);
  }
  
  console.log('[DOMContentLoaded] Finished initial theme/background logic.');
  
  const classicOptions = document.getElementById('classicOptions');
  if (classicOptions) {
    if (localStorage.getItem('gameMode') === 'classic') {
        classicOptions.style.display = 'block';
    } else {
        classicOptions.style.display = 'none';
    }
  }
  const savedLang = localStorage.getItem('language');
  if (savedLang) {
    const languageSelect = document.getElementById('languageSelect');
    if (languageSelect) languageSelect.value = savedLang;
  }
  applyTranslations();
  
  // Gestisci la visibilità iniziale delle sezioni di autenticazione/reset
  // RIMOSSO BLOCCO IF/ELSE IF QUI - LA LOGICA SARA' GESTITA DA updateAuthUI()
  // CHIAMATA CENTRALIZZATA a updateAuthUI per lo stato iniziale.
  updateAuthUI();

  if (localStorage.getItem('shopJustPaid') === '1') {
    let pollCount = 0;
    const pollInterval = setInterval(() => {
      if (window.socket) {
        window.socket.emit('getProfile');
      } else if (typeof socket !== 'undefined') {
        socket.emit('getProfile');
      }
      pollCount++;
      if (pollCount >= 5) {
        clearInterval(pollInterval);
        localStorage.removeItem('shopJustPaid');
      }
    }, 2000);
  }

  // DEBUG: Mostra sempre la sezione forgot password all'avvio (rimuovi dopo il debug)
  window.addEventListener('DOMContentLoaded', () => {
    // ... codice esistente ...
    const forgotPasswordSection = document.getElementById('forgotPasswordSection');
    if (forgotPasswordSection) {
      forgotPasswordSection.style.display = 'block';
      console.log('[DEBUG] forgotPasswordSection forzata visibile all\'avvio');
    }
    // ... resto codice esistente ...
  });

  // Log di debug per i riferimenti
  const showForgotPasswordFormLink = document.getElementById('showForgotPasswordForm');
  console.log('[DEBUG] showForgotPasswordFormLink:', showForgotPasswordFormLink);
  const forgotPasswordSection = document.getElementById('forgotPasswordSection');
  console.log('[DEBUG] forgotPasswordSection:', forgotPasswordSection);

  if (showForgotPasswordFormLink) {
    showForgotPasswordFormLink.addEventListener('click', (e) => {
      e.preventDefault();
      console.log('[DEBUG] click su Password dimenticata?');
      if (authSection) authSection.style.display = 'none';
      if (guestSection) guestSection.style.display = 'none';
      if (forgotPasswordSection) {
        forgotPasswordSection.style.display = 'block';
        console.log('[DEBUG] forgotPasswordSection visibile dopo click');
      }
      if (forgotPasswordMessage) forgotPasswordMessage.textContent = '';
      hideFormError('login');
    });
  }
});




// Funzione globale per mostrare/nascondere la chat della lobby
function updateLobbyChatVisibility() {
  var lobbyChatContainer = document.getElementById('lobbyChatContainer');
  var isMultiplayer = false;
  if (window.lobbyPlayers && Array.isArray(window.lobbyPlayers)) {
    isMultiplayer = window.lobbyPlayers.length > 1;
  } else if (typeof singlePlayerMode !== 'undefined') {
    isMultiplayer = !singlePlayerMode;
  }
  if (lobbyChatContainer) {
    lobbyChatContainer.style.display = isMultiplayer ? 'block' : 'none';
  }
}



socket.on('shopBalanceUpdated', () => {
  socket.emit('getProfile');
});



// ... (all'inizio del file, dopo le altre dichiarazioni di variabili globali)
const forgotPasswordSection = document.getElementById('forgotPasswordSection');
const authSection = document.getElementById('authSection');
const guestSection = document.getElementById('guestSection'); // Aggiunto riferimento a guestSection
const showForgotPasswordFormLink = document.getElementById('showForgotPasswordForm');
const forgotInput = document.getElementById('forgotInput'); // Modificato da forgotEmailInput
const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
const backToLoginBtn = document.getElementById('backToLoginBtn');
const forgotPasswordMessage = document.getElementById('forgotPasswordMessage');

// ... (resto del codice esistente) ...

// --- LOGICA PER FORGOT PASSWORD ---
if (showForgotPasswordFormLink) {
  showForgotPasswordFormLink.addEventListener('click', (e) => {
    e.preventDefault();
    if (authSection) authSection.style.display = 'none';
    if (guestSection) guestSection.style.display = 'none'; // Nascondi anche guestSection
    if (forgotPasswordSection) forgotPasswordSection.style.display = 'block';
    if (forgotPasswordMessage) forgotPasswordMessage.textContent = '';
    hideFormError('login');
  });
}

if (backToLoginBtn) {
  backToLoginBtn.addEventListener('click', () => {
    if (forgotPasswordSection) forgotPasswordSection.style.display = 'none';
    if (authSection) authSection.style.display = 'block';
    if (guestSection) guestSection.style.display = 'block'; // Ri-mostra guestSection quando torni al login
    hideFormError('login');
    // Ensure top bar is updated if needed, though typically auth screen has minimal top bar
    updateTopBarVisibility();
  });
}

if (forgotPasswordBtn) {
  forgotPasswordBtn.addEventListener('click', async () => {
    const userInput = forgotInput.value.trim(); // Modificato da email
    if (!userInput) {
      forgotPasswordMessage.textContent = 'Per favore, inserisci il tuo username.'; // Messaggio modificato
      forgotPasswordMessage.style.color = 'red';
      return;
    }

    try {
      forgotPasswordBtn.disabled = true;
      forgotPasswordMessage.textContent = 'Invio richiesta...';
      forgotPasswordMessage.style.color = 'var(--text-color)';

      const response = await fetch('/api/auth/forgot-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: userInput }) // Modificato per inviare username
      });

      const data = await response.json();

      if (response.ok) {
        // Messaggio leggermente modificato per riflettere l'username
        forgotPasswordMessage.textContent = data.message || 'Se il tuo username è valido, riceverai istruzioni (controlla la console del server per il link/token simulato).';
        forgotPasswordMessage.style.color = 'green';
        forgotInput.value = ''; // Pulisci l'input
      } else {
        forgotPasswordMessage.textContent = data.message || 'Errore durante la richiesta di reset.';
        forgotPasswordMessage.style.color = 'red';
      }
    } catch (error) {
      console.error('Errore fetch /forgot-password:', error);
      forgotPasswordMessage.textContent = 'Errore di connessione con il server.';
      forgotPasswordMessage.style.color = 'red';
    }
    forgotPasswordBtn.disabled = false;
  });
}

// Funzione showSection modificata
const originalShowSection = window.showSection;
window.showSection = function(sectionId) {
  if (typeof originalShowSection === 'function') {
    originalShowSection(sectionId);
  }
  // Nascondi sempre le sezioni specifiche di autenticazione/reset quando si cambia sezione principale
  if (authSection && sectionId !== 'authSection') authSection.style.display = 'none';
  if (guestSection && sectionId !== 'authSection' && sectionId !== 'guestSection') guestSection.style.display = 'none'; // Assicura che guestSection sia gestita
  if (forgotPasswordSection && sectionId !== 'forgotPasswordSection') forgotPasswordSection.style.display = 'none';

  // Casi specifici per la navigazione da/verso le schermate di autenticazione
  if (sectionId === 'authSection') {
    if (guestSection) guestSection.style.display = 'block';
    if (forgotPasswordSection) forgotPasswordSection.style.display = 'none';
  } else if (sectionId === 'forgotPasswordSection') {
    if (authSection) authSection.style.display = 'none';
    if (guestSection) guestSection.style.display = 'none';
  }
};

window.addEventListener('DOMContentLoaded', () => {
  // ... (codice esistente in DOMContentLoaded) ...
  // Assicura che forgotPasswordSection e guestSection siano gestite correttamente all'avvio
  // in base allo stato di autenticazione (updateAuthUI dovrebbe già farlo in parte)
  updateAuthUI(); // Chiamata per impostare la visibilità iniziale corretta
});

function updateAuthUI() {
  const token = localStorage.getItem('token');
  const setupSection = document.getElementById('setupSection');

  // Rileva se la sezione forgotPasswordSection è già visibile
  const forgotPasswordSection = document.getElementById('forgotPasswordSection');
  const isForgotVisible = forgotPasswordSection && forgotPasswordSection.style.display === 'block';

  if (token) {
    if (authSection) authSection.style.display = 'none';
    if (guestSection) guestSection.style.display = 'none';
    // NON nascondere forgotPasswordSection se è già visibile
    if (forgotPasswordSection && !isForgotVisible) forgotPasswordSection.style.display = 'none';
    if (setupSection) showSetupSection(); // o mainMenu, a seconda della logica
  } else {
    if (authSection) authSection.style.display = 'block';
    if (guestSection) guestSection.style.display = 'block';
    // NON nascondere forgotPasswordSection se è già visibile
    if (forgotPasswordSection && !isForgotVisible) forgotPasswordSection.style.display = 'none';
    if (setupSection) setupSection.style.display = 'none';
    const mainMenu = document.getElementById('mainMenu');
    if (mainMenu) mainMenu.style.display = 'none';
  }
}
// ... (resto del codice esistente) ...

// ... esistente ...
function updateTopBarVisibility() {
  const isLoggedIn = !!localStorage.getItem('token');
  // Box stats
  const trophiesBox = document.getElementById('trophiesBox');
  const coinsBox = document.getElementById('coinsBox');
  const gemsBox = document.getElementById('gemsBox');
  if (trophiesBox) trophiesBox.style.display = isLoggedIn ? 'flex' : 'none';
  if (coinsBox) coinsBox.style.display = isLoggedIn ? 'flex' : 'none';
  if (gemsBox) gemsBox.style.display = isLoggedIn ? 'flex' : 'none';
  // Icone top bar (tranne tema)
  ['leaderboardButton','missionsButton','shopButton','friendsButton','profileButton'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = isLoggedIn ? 'inline-block' : 'none';
  });
  // Tema chiaro/scuro sempre visibile
  const themeToggle = document.getElementById('themeToggle');
  if (themeToggle) themeToggle.style.display = 'inline-block';
}

window.addEventListener('DOMContentLoaded', () => {
  updateTopBarVisibility();
  updateAuthUI();
});

// Dopo login/registrazione
function onLoginSuccess() {
  updateTopBarVisibility();
}

// Dopo logout
logoutButton.addEventListener('click', () => {
  localStorage.removeItem('token');
  localStorage.removeItem('username');
  localStorage.removeItem('country');
  localStorage.removeItem('language');
  localStorage.removeItem('isGuest'); // Crucial: ensure guest mode is off
  localStorage.removeItem('avatar');
  localStorage.removeItem('background');
  // Clear other session items
  ['profileCoins', 'profileGems', 'profileTrophies', 'themeBeforeBackground', 
   'missionsCycleStart', 'missionsCycleMissions', 'userMissions', 'powerups', 
   'shopLastFetch', 'dailyShopItems'].forEach(item => localStorage.removeItem(item));


  // Resetta avatar nella UI
  if (document.getElementById('profileAvatar')) {
    document.getElementById('profileAvatar').src = 'avatars/avatar1.png'; // Default
  }
  
  applyBackgroundTheme(null); 
  
  updateAuthUI(); // This will now show login/register as token and isGuest are removed
  updateTopBarVisibility(); 
  updateThemeToggleVisibility();
});

// Nuovo gestore per la select dei temi
const themeSelect = document.getElementById('themeSelect');
if (themeSelect) {
  // Imposta il valore iniziale dalla preferenza salvata
  const savedTheme = localStorage.getItem('theme') || 'light';
  themeSelect.value = savedTheme;
  document.body.setAttribute('data-theme', savedTheme);

  themeSelect.addEventListener('change', () => {
    const selectedTheme = themeSelect.value;
    document.body.setAttribute('data-theme', selectedTheme);
    localStorage.setItem('theme', selectedTheme);
  });
}

window.addEventListener('DOMContentLoaded', function() {
  const themeSelect = document.getElementById('themeSelect');
  if (themeSelect) {
    // Imposta il valore iniziale dalla preferenza salvata
    const savedTheme = localStorage.getItem('theme') || 'light';
    themeSelect.value = savedTheme;
    document.body.setAttribute('data-theme', savedTheme);

    themeSelect.addEventListener('change', () => {
      const selectedTheme = themeSelect.value;
      document.body.setAttribute('data-theme', selectedTheme);
      localStorage.setItem('theme', selectedTheme);
    });
  }
});

// ... existing code ...
// Ripristino la logica originale del toggle tema chiaro/scuro
window.addEventListener('DOMContentLoaded', function() {
  const themeToggle = document.getElementById('themeToggle');
  const body = document.body;
  if (themeToggle) {
    // Imposta l'icona corretta all'avvio
    const savedTheme = localStorage.getItem('theme') || 'light';
    body.setAttribute('data-theme', savedTheme);
    themeToggle.innerHTML = savedTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';

    themeToggle.addEventListener('click', () => {
      const isDark = body.getAttribute('data-theme') === 'dark';
      const nextTheme = isDark ? 'light' : 'dark';
      body.setAttribute('data-theme', nextTheme);
      localStorage.setItem('theme', nextTheme);
      themeToggle.innerHTML = nextTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    });
  }
});
// ... existing code ...

// ... existing code ...
// Toggle tema chiaro/scuro minimale e funzionante
window.addEventListener('DOMContentLoaded', function() {
  const themeToggle = document.getElementById('themeToggle');
  const body = document.body;
  if (themeToggle) {
    // Imposta il tema e l'icona all'avvio
    const savedTheme = localStorage.getItem('theme') || 'light';
    body.setAttribute('data-theme', savedTheme);
    themeToggle.innerHTML = savedTheme === 'dark'
      ? '<i class="fas fa-sun"></i>'
      : '<i class="fas fa-moon"></i>';

    themeToggle.addEventListener('click', () => {
      const isDark = body.getAttribute('data-theme') === 'dark';
      const nextTheme = isDark ? 'light' : 'dark';
      body.setAttribute('data-theme', nextTheme);
      localStorage.setItem('theme', nextTheme);
      themeToggle.innerHTML = nextTheme === 'dark'
        ? '<i class="fas fa-sun"></i>'
        : '<i class="fas fa-moon"></i>';
    });
  }
});
// ... existing code ...

// ... existing code ...
// Funzione per mostrare/nascondere il bottone tema in base allo sfondo attivo
function updateThemeToggleVisibility() {
  const themeToggle = document.getElementById('themeToggle');
  const bg = localStorage.getItem('background');
  const guestMode = isGuestMode();

  if (themeToggle) {
    if (guestMode) {
      // Guests always have light/dark toggle, no custom backgrounds for them via setBackground
      themeToggle.style.display = 'inline-block';
      const currentTheme = document.body.getAttribute('data-theme') || localStorage.getItem('theme') || 'light';
      themeToggle.innerHTML = currentTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    } else if (bg && bg !== 'null' && bg !== 'undefined' && bg !== '') {
      // Logged-in user with a custom background
      themeToggle.style.display = 'none';
    } else {
      // Logged-in user, no custom background, or user logged out
      themeToggle.style.display = 'inline-block';
      const currentTheme = document.body.getAttribute('data-theme') || localStorage.getItem('theme') || 'light';
      themeToggle.innerHTML = currentTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    }
  }
}

// Modifica applyBackgroundTheme per chiamare updateThemeToggleVisibility sempre
// This is already handled by applyBackgroundTheme calling it, or by callers of applyBackgroundTheme.

// Modifica setBackground per chiamare updateThemeToggleVisibility dopo ogni cambio
// const originalSetBackground = window.setBackground; // This was already done
// window.setBackground = function(path) {
//   if (isGuestMode()) { /* ... guest logic ... */ return; }
//   originalSetBackground.call(this, path); // Call original for non-guests
//   updateThemeToggleVisibility(); // Then update toggle
// }
// This re-wrap is tricky. Let's ensure the original setBackground calls updateThemeToggleVisibility internally or its callers do.
// The current setBackground is fine, as applyBackgroundTheme (which it calls) and its own logic paths will lead to updateThemeToggleVisibility.

// All'avvio, dopo aver applicato lo sfondo o il tema, chiama updateThemeToggleVisibility
window.addEventListener('DOMContentLoaded', () => {
  // updateAuthUI, updateTopBarVisibility are already called.
  // updateThemeToggleVisibility is called by them or by applyBackgroundTheme.
  // Explicit call here might be redundant but safe.
  updateThemeToggleVisibility();
});

// Dopo login/logout, chiama updateThemeToggleVisibility
// This is already handled in onLoginSuccess and logoutButton.addEventListener
// ... existing code ...



